<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Aurora</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
	<!-- DataTables -->
	<link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<!-- daterange picker -->
	<link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
	<!-- Toast Grid -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<!-- jQuery OrgChart CSS CDN -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/orgchart/5.0.0/css/jquery.orgchart.min.css" integrity="sha512-9A2BSSUL5eXVMWwrB8aDX8GeOOSMMVCk3fvqOplnswmo4IN4s6DW2ywpb3VCDcGCVwDc3g6S1k9T72NsCkgw5A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<!-- jsTree CSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
	<style>
	    #divinfo {
	        display: none; /* 기본적으로 숨김 */
	    }
	</style>
</head>
<body class="layout-top-nav">
	<div class="wrapper">

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- 콘텐츠 헤더 (Page header) -->
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>로트추적</h1>
						</div>
					</div>
				</div>
			</section>
			<!-- /.콘텐츠 헤더 (Page header) -->
			<!-- 메인 콘텐츠 -->
			<section class="content">
				<div class="col-2">
				</div>
				<div class="container-fluid">
					<div class="row">
						<div class="col-3">
							<div class="card">
								<div class="card-body">
									<div id="lot_grid"></div>
								</div>
							</div>
						</div>
						<div class="col-3">
							<div class="card">
								<div class="card-body">
									<div id="lot_tree" class="bg-white border rounded"
										style="height: calc(100vh - 300px); overflow-y: scroll;">
									</div>
								</div>
							</div>
						</div>
						<div class="col-6">
							<div class="card" id="detail_info">
								<div class="card-body">
									<div  id="divinfo">
									<div class="row">
						                <div class="col-12">
						                  <h4 class="CLIENT_NAME">
						                  </h4>
						                </div>
						              </div>
									  <div class="row invoice-info">
						                  <div class="col-sm-4 invoice-col">
						                    <address id="client_info">
						                      <strong class="CLIENT_NAME"></strong><br>
						                      주소: <a id="CLIENT_ADDRESS"></a><br>
						                      회사전화: <a id="CLIENT_TEL"></a><br>
						                      담당자: <a id="REST_NAME"></a>
						                    </address>
						                  </div>
						                  <!-- /.col -->
						                  <div class="col-sm-4 invoice-col">
						                  </div>
						                  <!-- /.col -->
						                  <div class="col-sm-4 invoice-col" id="goodsInfo">
						                    <b id="MATERIAL"></b><br>
						                    <br>
											단가: <a id="MATERIAL_PRICE"></a><br>
											입고수량: <a id="TOTAL_QUANTITY"></a>
											양품수량: <a id="QUANTITY"></a>
											불량수량: <a id="REJECTION_QUANTITY"></a>
						                  </div>
						                  <!-- /.col -->
						                </div>
									<div id="toast_single">
											<!-- Toast Grid Ajax -->
									</div>
									</div>
								</div>
							</div>
						</div>
						<!--
						<div class="col-4">
							<div class="card">
								<div class="card-header">
									<h3>Lot Tracking Node Test</h3>
								</div>
								<div class="row">
									<div class="card-body d-flex justify-content-center align-items-center">
										<div id="chart_container">
										</div>
									</div>
								</div>
							</div>
						</div>
						-->
					</div>
					<!-- /.col -->
				</div>
			<!-- /.container-fluid -->
			</section>
		<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
		</aside>
	<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->

	<!-- jQuery -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<!-- jsTree JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- Select2 -->
	<script src="../../plugins/select2/js/select2.full.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../../dist/js/adminlte.min.js"></script>
	<!-- AdminLTE for demo purposes -->
	<script src="../../dist/js/demo.js"></script>
	<!-- InputMask -->
	<script src="../../plugins/moment/moment.min.js"></script>
	<script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>
	<!-- date-range-picker -->
	<script src="../../plugins/daterangepicker/daterangepicker.js"></script>
	<!-- Tempusdominus Bootstrap 4 -->
	<script src="../../plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
	<!-- Toast Grid -->
	<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>
	<!-- jQuery OrgChart JS CDN -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/orgchart/5.0.0/js/jquery.orgchart.min.js" integrity="sha512-IUNqrYw8R7mj0iBzb0FOTGTgEFrxZCHVCHnePUEmcjJ/XQE/0sqRhBmGpp20N2lVzAkIBs0Sz+ibRN8/W9YFnQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<!-- Page specific script -->
	<script th:inline="javascript">
		 let po_id = '';
		
		let grid1 = null;
 		const lot_url = '/rest/lots';
		const lot_dataSource = {
			api: {
				readData: {url: lot_url, method: 'GET'},
			},
			contentType: 'application/json',
		};

		$(function () {
			lotGrid();
		});

		function lotGrid() {
			lotGrid = new tui.Grid({
				el: document.getElementById('lot_grid'),
				data: lot_dataSource,
				scrollX: true,
				scrollY: true,
				columns: [
					{header: 'LOT', name: 'PRODUCTION_LOT_ID', align: 'center'},
					{header: '제품명', name: 'ITEM_NAME', align: 'left', width: 100},
				],
			});
			
			lotGrid.on('failResponse', function(ev) {
				alert(JSON.parse(ev.xhr.responseText).message);
			});
			
			lotGrid.on('click', (ev) => {
				if (ev.targetType != "cell") {
					return;
				}
				
				lotGrid.setSelectionRange({
					start: [ev.rowKey, 0],
					end: [ev.rowKey, lotGrid.getColumns().length]
				});
				
				const lotId = lotGrid.getValue(ev.rowKey, "PRODUCTION_LOT_ID");
				console.log(lotId)
				loadLotTree(lotId);
			});
		}
		
		
// -------------------------------------------------------------------------------------------
		//Tree

		function loadLotTree(lotId) {
		    $.ajax({
		        url: '/ajax/lotHierarchy',
		        type: 'POST',
		        contentType: 'application/json',
		        data: JSON.stringify({ lotId: lotId }),
		        success: function (response) {
					
		            let treeData = transformData(response);
					
					$('#lot_tree').jstree({
		                'core' : {
		                "animation" : 0,
		                "check_callback": true,
		                'data' : treeData
		                }
		            });
					
					
		        },
		        error: function (error) {
		            console.error('❌ 데이터 요청 실패:', error);
		        }
		    });
		}

		function transformData(data) {
		    let treeData = [];
		    let nodeMap = {};

		    data.forEach(row => {
		        let lotId = row.PRODUCTION_LOT_ID;
		        let itemLot = row.ITEM_LOT;
		        let level = row.LEVEL;

		        
		        if (!nodeMap[lotId]) {
		            nodeMap[lotId] = {
		                id: lotId,
		                parent: "#",
		                menuOrder: Object.keys(nodeMap).length + 1,
		                menuDepth: 1,
		                text: `${lotId}`
		            };
		            treeData.push(nodeMap[lotId]);
		        }

		       
		        if (!nodeMap[itemLot]) {
		            nodeMap[itemLot] = {
		                id: itemLot,
		                parent: lotId,
		                menuOrder: Object.keys(nodeMap).length + 1,
		                menuDepth: level + 1,
		                text: ` ${itemLot}`
		            };
		            treeData.push(nodeMap[itemLot]);
		        }
		    });

		    return treeData;
		}

		
		$('#lot_tree').on('select_node.jstree', function(e,data){
			let select_id = data.node.id;
			console.log(select_id);
			$.ajax({
		        url: '/ajax/lotDetailInfo',
		        type: 'POST',
		        contentType: 'application/json',
		        data: JSON.stringify({ select_id: select_id }),
		        success: function (response) {
					console.log(response);
					info(response);
					$("#divinfo").show();
		        },
		        error: function (error) {
		            console.error('❌ 데이터 요청 실패:', error);
		        }
			});
			
		});
		
		function info(data) {
		    if (data.lotDetail && data.lotDetail.length > 0) {
		        let detail = data.lotDetail[0];
				
				po_id = detail.PO_ID;
				
		        $(".CLIENT_NAME").text(detail.CLIENT_NAME);
		        $("#CLIENT_ADDRESS").text(detail.CLIENT_ADDRESS);
		        $("#CLIENT_TEL").text(detail.CLIENT_TEL);
		        $("#REST_NAME").text(detail.REST_NAME);
		        $("#MATERIAL").text(`발주번호: ${detail.PO_ID}`);
		    }

		    if (data.materialInfo && data.materialInfo.length > 0) {
		        let material = data.materialInfo[0];

		        $("#MATERIAL_PRICE").text(material.MATERIAL_PRICE.toLocaleString() + " 원");
		        $("#QUANTITY").text(material.QUANTITY.toLocaleString() + " 개");
		        $("#MATERIAL").text(material.MATERIAL);
		    }
			grid();
		}

// ---------------------------------------------------------------------------------
		
		function grid() {
			
			if (grid1) {
				grid1.destroy();
				grid1 = null;
	        }
			
			const url = '/rest/inboundInspection';
			const dataSource = {
		        api: {
		            readData: {url: url, method: 'GET', initParams: { po_id: po_id } },
		        },
				contentType: 'application/json',
		    };
			
		    grid1 = new tui.Grid({
		        el: document.getElementById('toast_single'),
		        data: dataSource,
		        scrollX: true,
		        scrollY: true,
		        columns: [
		            {header: 'LOT', name: 'INSPECTION_ID', align: 'center', editor: 'text'},
		            {header: '불량사유', name: 'REJECTION', align: 'center', editor: 'text'},
		            {header: '수량', name: 'DEFECT_QUANTITY', align: 'center', editor: 'text'}
		        ],
		    });

		    grid1.on('failResponse', function(ev) {
		        alert(JSON.parse(ev.xhr.responseText).message);
		    });
			
			
		}

	</script>
</body>
</html>