<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AdminLTE 3 | 인사관리</title>

<!-- Google Font: Source Sans Pro -->
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/1.1.34/css/materialdesignicons.css">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<!-- Font Awesome -->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
	rel="stylesheet">
<!-- daterange picker -->
<link rel="stylesheet"
	href="../../plugins/daterangepicker/daterangepicker.css">
<!-- Select2 -->
<link rel="stylesheet" href="../../plugins/select2/css/select2.min.css">
<link rel="stylesheet"
	href="../../plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
<!-- Theme style -->
<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
<!-- jsTree CSS -->
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
</head>
<body class="hold-transition sidebar-mini">
	<div class="wrapper">

		<!-- 상단 메뉴 -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.상단 메뉴 -->

		<!-- 좌측 메뉴 -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.좌측 메뉴 -->

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- 콘텐츠 헤더 (Page header) -->
			<section class="content-header">
				<div class="container-fluid">

					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>조직현황</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">Home</a></li>
								<li class="breadcrumb-item active">조직현황</li>
							</ol>
						</div>
					</div>
				</div>
			</section>
			<!-- /.콘텐츠 헤더 (Page header) -->
			<!-- 메인 콘텐츠 -->
			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-body">
									<p class="font-weight-bold">조직도</p>
									<div class="row">
										<div class="col-4">
											<div id="orgTree" class="bg-white border rounded"
												style="height: calc(100vh - 300px); overflow-y: scroll;">

											</div>
										</div>
										<div class="col-8">
											<div id="employeeTree" class="bg-white border rounded p-2"
												style="height: 300px; overflow-y: scroll;">
												<!-- 해당 부서 소속 직원  -->
											</div>
										</div>
									</div>
								</div>
								<!-- /.card-body -->
							</div>
							<!-- /.card -->
						</div>
						<!-- /.col -->
					</div>
					<!-- /.row -->
				</div>
				<!-- /.container-fluid -->
			</section>
			<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
		<!-- 좌측 메뉴 -->
		<footer th:replace="~{includes/footer :: footer}"></footer>
		<!-- /.좌측 메뉴 -->
		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
			<!-- Control sidebar content goes here -->
		</aside>
		<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->


	<!-- jQuery -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<!-- jsTree JS -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- Select2 -->
	<script src="../../plugins/select2/js/select2.full.min.js"></script>
	<!-- InputMask -->
	<script src="../../plugins/moment/moment.min.js"></script>
	<script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>
	<!-- date-range-picker -->
	<script src="../../plugins/daterangepicker/daterangepicker.js"></script>
	<!-- Tempusdominus Bootstrap 4 -->
	<script
		src="../../plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../../dist/js/adminlte.min.js"></script>
	<!-- AdminLTE for demo purposes -->
	<script src="../../dist/js/demo.js"></script>
	<!-- DataTables  & Plugins -->
	<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
	<script
		src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
	<script
		src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
	<script
		src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
	<script
		src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
	<script
		src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
	<script>
$(document).ready(function () {
    loadOrgTree(); // 페이지 로드 시 조직도 데이터 로드
});

// 전역 변수 선언
let groupedData = {}; 
let ceo = null;  // 사장 정보

// 조직도 데이터 로드
function loadOrgTree() {
    $.ajax({
        url: "/appoint/getOrgTree", // 조직도 데이터 API 호출
        method: "GET",
        success: function (data) {
            renderOrgTree(data); // 데이터 로딩 후 조직도 렌더링
        },
        error: function (error) {
            console.error("Error fetching org tree:", error); // 데이터 로딩 실패 시 에러 출력
        }
    });
}

// 조직도 렌더링 함수
function renderOrgTree(data) {
    const treeContainer = $("#orgTree");
    treeContainer.empty(); // 기존 내용 삭제

    groupedData = {};  // groupedData 초기화
    ceo = null;  

    data.forEach(item => {
        const department = item.PARENTDEPTNAME || item.DEPTNAME || "기타"; // 부서 정보 처리

        if (item.GRADENAME === "사장") {
            ceo = {
                "text": `${item.MEMBERNAME} (${item.GRADENAME})`,
                "state": { "opened": true },
                "data-member-id": item.MEMBERID,
                "data-member-name": item.MEMBERNAME,
                "children": [] 
            };
        }

        if (department !== "기타") {
            if (!groupedData[department]) {
                groupedData[department] = { deptName: department, teams: {} };  
            }

            if (item.PARENTDEPTNAME) {
                const team = item.DEPTNAME || "기타"; 
                const member = {
                    "text": `${item.MEMBERNAME} (${item.GRADENAME || '직원'})`,
                    "state": { "opened": true },
                    "data-member-id": item.MEMBERID,
                    "data-member-name": item.MEMBERNAME,
                };

                if (!groupedData[department].teams[team]) {
                    groupedData[department].teams[team] = []; 
                }

                groupedData[department].teams[team].push(member); 
            }
        }
    });

    const treeData = [];

    const companyNode = {
        "text": "회사", 
        "state": { "opened": true },
        "children": [] 
    };
    treeData.push(companyNode);

    if (ceo) {
        const ceoNode = {
            "text": ceo.text,
            "state": { "opened": true },
            "children": [] 
        };
        companyNode.children.push(ceoNode);

        Object.keys(groupedData).forEach(department => {
            if (department !== "기타") {
                const departmentNode = {
                    "text": `${department} (${getTotalMembersInDepartment(department)})`,
                    "state": { "opened": true },
                    "data-department": department,  // 부서 데이터 추가
                    "children": []
                };

                Object.keys(groupedData[department].teams).forEach(team => {
                    const teamNode = {
                        "text": `${team} (${groupedData[department].teams[team].length})`,
                        "state": { "opened": true },
                        "data-team-id": team, 
                        "data-team-name": team,
                        "children": [] 
                    };

                    departmentNode.children.push(teamNode);  
                });

                ceoNode.children.push(departmentNode);  
            }
        });
    }

    // "기타" 부서가 있을 경우 처리
    if (groupedData["기타"]) {
        companyNode.children.push({
            "text": "기타",
            "state": { "opened": true },
            "children": groupedData["기타"].teams["기타"].map(member => ({
                "text": member.text,
                "data-member-id": member["data-member-id"],
                "data-member-name": member["data-member-name"],
            }))
        });
    }

    // jsTree 초기화
    $('#orgTree').jstree({
        'core': {
            'data': treeData
        }
    });

    // 부서 클릭 이벤트 처리 (부서 클릭 시 해당 부서의 모든 팀원 표시)
    $('#orgTree').on("select_node.jstree", function (e, data) {
        const departmentName = data.node.original['data-department'];
        if (departmentName) {
            console.log("Department Clicked: ", departmentName);  // 부서 클릭 시 부서명이 제대로 전달되는지 확인
            showEmployeesInDepartment(departmentName); // 부서를 클릭했을 때 해당 부서의 직원 목록 표시
        } else if (data.node.original['data-team-id']) {
            const teamId = data.node.original['data-team-id'];
            const teamName = data.node.original['data-team-name'];
            showEmployeesInTeam(teamId, teamName); // 팀 클릭 시 해당 팀원 목록 표시
        }
    });
}

// 부서 소속 직원 목록을 #employeeTree로 표시
function showEmployeesInDepartment(departmentName) {
    const employeeTreeContainer = $("#employeeTree");
    employeeTreeContainer.empty();  // 기존 내용 삭제

    const departmentData = groupedData[departmentName];  // groupedData에서 부서 데이터 찾기

    console.log("Department Data: ", departmentData);  // 부서 데이터가 잘 들어왔는지 확인

    if (departmentData && departmentData.teams) {
        let employeeListHtml = "";
        // 부서의 모든 팀을 순회하여 팀원 추가
        Object.keys(departmentData.teams).forEach(team => {
            const teamMembers = departmentData.teams[team];
            if (teamMembers.length > 0) {
                employeeListHtml += teamMembers.map(member => 
                    `<div class="employee-item">
                        <p><strong>${member['data-member-name']}</strong> (${getGrade(member)})</p>
                    </div>`).join('');
            } else {
                employeeListHtml += `<h5>${team} 팀 직원 목록</h5><p>이 팀에 소속된 직원이 없습니다.</p>`;
            }
        });
        employeeTreeContainer.html(employeeListHtml);
    } else {
        employeeTreeContainer.html("<p>이 부서에 소속된 직원이 없습니다.</p>");
    }
}

// 부서 내 총 인원 수 구하기
function getTotalMembersInDepartment(departmentName) {
    const departmentData = groupedData[departmentName];
    let totalMembers = 0;

    if (departmentData && departmentData.teams) {
        Object.keys(departmentData.teams).forEach(team => {
            totalMembers += departmentData.teams[team].length;
        });
    }

    return totalMembers;
}

// 팀 소속 직원 목록을 #employeeTree로 표시
function showEmployeesInTeam(teamId, teamName) {
    const employeeTreeContainer = $("#employeeTree");
    employeeTreeContainer.empty();  // 기존 내용 삭제

    let found = false;
    // 팀 데이터 찾기
    Object.keys(groupedData).forEach(departmentName => {
        const teamData = groupedData[departmentName].teams[teamName];
        
        if (teamData) {
            found = true;
            const employeeListHtml = teamData.map(member => 
                `<div class="employee-item">
                    <p><strong>${member['data-member-name']}</strong> (${getGrade(member)})</p>
                </div>`).join('');
            employeeTreeContainer.html(`${employeeListHtml}`);
        }
    });

    if (!found) {
        employeeTreeContainer.html("<p>선택한 팀에 데이터가 없습니다.</p>");
    }
}

// 직원의 직급을 반환하는 함수
function getGrade(member) {
    if (member && member.state && member.state.text) {
        // 직급을 괄호에서 추출
        return member.state.text.split('(')[1].replace(')', '');
    }
    return "직원";  // 직급 정보가 없으면 "직원"으로 처리
}
</script>


	<style>
.form-control-custom {
	display: block;
	width: 100%;
	height: 2rem;
	padding: .375rem .75rem;
	font-size: 0.9rem;
	font-weight: 400;
	line-height: 1.5;
	color: #495057;
	outline-color: #80bdff;
	background-color: #ffffff00;
	background-clip: padding-box;
	border: 1px solid #ced4daa3;
	border-radius: .25rem;
	box-shadow: inset 0 0 0 transparent;
	transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
}

.form-control-custom2 {
	display: block;
	width: 100%;
	height: 2rem;
	padding: .375rem .75rem;
	font-size: 0.9rem;
	font-weight: 400;
	line-height: 1.5;
	color: #495057;
	outline: none;
	background-color: #ffffff00;
	background-clip: padding-box;
	border: none;
	box-shadow: inset 0 0 0 transparent;
	-o-appearance: none;
	-webkit-appearance: none;
	-moz-appearance: none;
	appearance: none;
}

.form-control-custom3 {
	display: block;
	width: 100%;
	height: auto;
	padding: .375rem .75rem;
	font-size: 0.9rem;
	font-weight: 400;
	line-height: 0.7;
	color: #495057;
	outline-color: #80bdff;
	background-color: #ffffff00;
	background-clip: padding-box;
	border: 1px solid #ced4daa3;
	border-radius: .25rem;
	box-shadow: inset 0 0 0 transparent;
	transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
	resize: none;
}

.form-control-custom:focus {
	outline: 0.5px solid #80bdff;
}

.orgNav:hover {
	background: #ebebeb;
}

.activeToggle {
	background: #e8eff9;
}

.custom-label {
	font-size: 0.95rem;
}

.newPosition {
	font-size: 0.82rem;
}

.newPosition p {
	margin-bottom: 4px;
}

.modal-dialog {
	position: relateive;
	top: 50%;
	transform: translateY(-60%) !important;
}

.pagination {
	justify-content: end;
}

.nav-sidebar .menu-open>.nav-treeview {
	display: block;
	height: 100% !important;
}

#orgTree {
	width: 100%;
	height: 400px; /* 높이를 명시적으로 지정 */
	border: 1px solid #ccc;
}
</style>
</body>
</html>
