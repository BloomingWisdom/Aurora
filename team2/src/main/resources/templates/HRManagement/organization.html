<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AdminLTE 3 | 인사관리</title>

<!-- Google Font: Source Sans Pro -->
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/1.1.34/css/materialdesignicons.css">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<!-- Font Awesome -->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
	rel="stylesheet">
<!-- daterange picker -->
<link rel="stylesheet"
	href="../../plugins/daterangepicker/daterangepicker.css">
<!-- Select2 -->
<link rel="stylesheet" href="../../plugins/select2/css/select2.min.css">
<link rel="stylesheet"
	href="../../plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
<!-- Theme style -->
<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
<!-- jsTree CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
</head>
<body class="hold-transition sidebar-mini">
	<div class="wrapper">

		<!-- 상단 메뉴 -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.상단 메뉴 -->

		<!-- 좌측 메뉴 -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.좌측 메뉴 -->

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- 콘텐츠 헤더 (Page header) -->
			<section class="content-header">
				<div class="container-fluid">

					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>조직현황</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">Home</a></li>
								<li class="breadcrumb-item active">조직현황</li>
							</ol>
						</div>
					</div>
				</div>
			</section>
			<!-- /.콘텐츠 헤더 (Page header) -->
			<!-- 메인 콘텐츠 -->
			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-body">
									<p class="font-weight-bold">조직도</p>
									<div class="row">
										<div class="col-4">
											<div id="orgTree" class="bg-white border rounded"
												style="height: calc(100vh - 300px); overflow-y: scroll;">
												
											</div>
										</div>
										<div class="col-8">
											<div id="employeeTree" class="bg-white border rounded p-2"
												style="height: 300px; overflow-y: scroll;"><!-- 해당 부서 소속 직원  --></div>
										</div>
									</div>
								</div>
								<!-- /.card-body -->
							</div>
							<!-- /.card -->
						</div>
						<!-- /.col -->
					</div>
					<!-- /.row -->
				</div>
				<!-- /.container-fluid -->
			</section>
			<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
		<!-- 좌측 메뉴 -->
		<footer th:replace="~{includes/footer :: footer}"></footer>
		<!-- /.좌측 메뉴 -->
		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
			<!-- Control sidebar content goes here -->
		</aside>
		<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->


	<!-- jQuery -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	 <!-- jsTree JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- Select2 -->
	<script src="../../plugins/select2/js/select2.full.min.js"></script>
	<!-- InputMask -->
	<script src="../../plugins/moment/moment.min.js"></script>
	<script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>
	<!-- date-range-picker -->
	<script src="../../plugins/daterangepicker/daterangepicker.js"></script>
	<!-- Tempusdominus Bootstrap 4 -->
	<script
		src="../../plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../../dist/js/adminlte.min.js"></script>
	<!-- AdminLTE for demo purposes -->
	<script src="../../dist/js/demo.js"></script>
	<!-- DataTables  & Plugins -->
	<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
	<script
		src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
	<script
		src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
	<script
		src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
	<script
		src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
	<script
		src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>


    <script>
        $(document).ready(function () {
            loadOrgTree(); // 페이지 로드 시 조직도 데이터 로드
        });

        // 전역 변수 선언
        let groupedData = {}; 

        // 조직도 데이터 로드
        function loadOrgTree() {
            $.ajax({
                url: "/appoint/getOrgTree", // 조직도 데이터 API 호출
                method: "GET",
                success: function (data) {
                    renderOrgTree(data); // 데이터 로딩 후 조직도 렌더링
                },
                error: function (error) {
                    console.error("Error fetching org tree:", error); // 데이터 로딩 실패 시 에러 출력
                }
            });
        }

        // 조직도 렌더링 함수
        function renderOrgTree(data) {
            const treeContainer = $("#orgTree");
            treeContainer.empty(); // 기존 내용 삭제

            // 데이터가 비어 있을 경우 처리
            if (!data || data.length === 0) {
                treeContainer.append("<p>조직 데이터를 찾을 수 없습니다.</p>");
                return;
            }

            // 데이터를 부서와 팀으로 그룹화
            groupedData = data.reduce((acc, item) => {
                const parentDept = item.PARENTDEPTNAME || item.DEPTNAME;

                if (!acc[parentDept]) {
                    acc[parentDept] = { deptName: parentDept, teams: [] };
                }

                if (item.PARENTDEPTNAME) {
                    const existingTeam = acc[parentDept].teams.find(t => t.teamId === item.DEPTID);
                    if (!existingTeam) {
                        acc[parentDept].teams.push({
                            teamName: item.DEPTNAME,
                            teamId: item.DEPTID,
                            members: []
                        });
                    }
                }
                return acc;
            }, {});

            data.forEach(item => {
                if (item.MEMBERNAME && item.PARENTDEPTNAME) {
                    const parentDept = groupedData[item.PARENTDEPTNAME];
                    const team = parentDept.teams.find(t => t.teamId === item.DEPTID);
                    if (team) {
                        team.members.push({
                            memberName: item.MEMBERNAME,
                            memberId: item.MEMBERID,
                            gradeName: item.GRADENAME
                        });
                    }
                }
            });
            
            // jsTree에서 사용될 트리 데이터 포맷으로 변환
            const treeData = Object.keys(groupedData).map(department => {
                const departmentNode = {
                    "text": department,
                    "children": groupedData[department].teams.map(team => ({
                        "text": team.teamName,
                        "data-team-id": team.teamId,
                        "data-team-name": team.teamName
                    }))
                };
                return departmentNode;
            });

            // jsTree 초기화
            $('#orgTree').jstree({
                'core': {
                    'data': treeData
                }
            });

            // 팀 클릭 이벤트 처리
            $('#orgTree').on("select_node.jstree", function (e, data) {
                const teamId = data.node.original['data-team-id'];
                const teamName = data.node.original['data-team-name'];
                showEmployeesInTeam(teamId, teamName);
            });
        }

        // 팀 소속 직원 목록을 #employeeTree로 표시
        function showEmployeesInTeam(teamId, teamName) {
            const employeeTreeContainer = $("#employeeTree");
            employeeTreeContainer.empty();  // 기존 내용 삭제

            // 조직도에서 해당 팀의 직원 목록 찾기
            const teamData = findTeamDataById(teamId);

            if (teamData && teamData.members.length > 0) {
                const employeeListHtml = teamData.members.map(member => `
                    <div class="employee-item">
                        <p><strong>${member.memberName}</strong> (${member.gradeName})</p>
                    </div>
                `).join('');
                employeeTreeContainer.html(`${employeeListHtml}`);
            } else {
                employeeTreeContainer.html(`<p>이 팀에 소속된 직원이 없습니다.</p>`);
            }
        }

        // 팀 ID로 팀 데이터 찾기
        function findTeamDataById(teamId) {
            let foundTeam = null;

            Object.keys(groupedData).forEach(department => {
                groupedData[department].teams.forEach(team => {
                    if (String(team.teamId) === String(teamId)) {
                        foundTeam = team;
                    }
                });
            });

            return foundTeam;
        }
    </script>
	<style>
.form-control-custom {
	display: block;
	width: 100%;
	height: 2rem;
	padding: .375rem .75rem;
	font-size: 0.9rem;
	font-weight: 400;
	line-height: 1.5;
	color: #495057;
	outline-color: #80bdff;
	background-color: #ffffff00;
	background-clip: padding-box;
	border: 1px solid #ced4daa3;
	border-radius: .25rem;
	box-shadow: inset 0 0 0 transparent;
	transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
}

.form-control-custom2 {
	display: block;
	width: 100%;
	height: 2rem;
	padding: .375rem .75rem;
	font-size: 0.9rem;
	font-weight: 400;
	line-height: 1.5;
	color: #495057;
	outline: none;
	background-color: #ffffff00;
	background-clip: padding-box;
	border: none;
	box-shadow: inset 0 0 0 transparent;
	-o-appearance: none;
	-webkit-appearance: none;
	-moz-appearance: none;
	appearance: none;
}

.form-control-custom3 {
	display: block;
	width: 100%;
	height: auto;
	padding: .375rem .75rem;
	font-size: 0.9rem;
	font-weight: 400;
	line-height: 0.7;
	color: #495057;
	outline-color: #80bdff;
	background-color: #ffffff00;
	background-clip: padding-box;
	border: 1px solid #ced4daa3;
	border-radius: .25rem;
	box-shadow: inset 0 0 0 transparent;
	transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
	resize: none;
}

.form-control-custom:focus {
	outline: 0.5px solid #80bdff;
}

.orgNav:hover {
	background: #ebebeb;
}

.activeToggle {
	background: #e8eff9;
}

.custom-label {
	font-size: 0.95rem;
}

.newPosition {
	font-size: 0.82rem;
}

.newPosition p {
	margin-bottom: 4px;
}

.modal-dialog {
	position: relateive;
	top: 50%;
	transform: translateY(-60%) !important;
}

.pagination {
	justify-content: end;
}

.nav-sidebar .menu-open>.nav-treeview{
	display: block;
	height: 100% !important;
}
 #orgTree {
            width: 100%;
            height: 400px; /* 높이를 명시적으로 지정 */
            border: 1px solid #ccc;
        }
</style>
</body>
</html>
