<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	<title>AdminLTE 3 | DataTables</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<!-- Toast UI Grid -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>
	
	<!-- jQuery -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../../dist/js/adminlte.min.js"></script>
	<!-- Toast UI Grid -->
	<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>
	<!-- SheetJS (Excel Î≥ÄÌôò ÎùºÏù¥Î∏åÎü¨Î¶¨) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	
	<style>
	    .selected-row {
	        background-color: #d1ffd6;
	    }
	    .deselected-row {
	        background-color: #ffd1d1;
	    }
	</style>
</head>
<body class="hold-transition sidebar-mini">
	<div class="wrapper">

		<!-- ÏÉÅÎã® Î©îÎâ¥ -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.ÏÉÅÎã® Î©îÎâ¥ -->

		<!-- Ï¢åÏ∏° Î©îÎâ¥ -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.Ï¢åÏ∏° Î©îÎâ¥ -->
		
		<!-- ÏóëÏÖÄ Í∏∞Îä• Î™®Îã¨ (ÎØ∏Íµ¨ÌòÑ) -->
		<!-- <nav th:replace="~{includes/modals/excelModal :: excelModal}"></nav> -->
		
		<!-- ÏÑ§ÎπÑÏΩîÎìú Ï§ëÎ≥µÏ≤òÎ¶¨ Í≤ÄÏ¶ù Î™®Îã¨ (ÎØ∏Íµ¨ÌòÑ) -->
		<nav th:replace="~{includes/modals/equipCodeAdd :: equipCodeAdd}"></nav>

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- ÏΩòÌÖêÏ∏† Ìó§Îçî (Page header) -->
			<nav th:replace="~{includes/pageHeader :: pageHeader}"></nav>

			<!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
								    <div class="d-flex justify-content-between align-items-center">
								        <div class="d-flex align-items-center">
								            <!-- ÏÑ§ÎπÑÎ™Ö -->
								            <label class="col-form-label" style="min-width: 70px">ÏÑ§ÎπÑÎ™Ö</label>
								            <input type="text" class="form-control mr-3" id="equip1" style="width: 150px;">
								
								            <!-- ÏÇ¨Ïö©Ïó¨Î∂Ä -->
								            <label class="col-form-label mr-2" style="min-width: 70px">ÏÇ¨Ïö©Ïó¨Î∂Ä</label>
								            <select class="equip3 form-control mr-3" name="equip3" style="min-width: 120px;">
								                <option selected="selected" disabled>ÏÇ¨Ïö©Ïó¨Î∂Ä</option>
								                <option>ÏÇ¨Ïö©</option>
								                <option>ÎØ∏ÏÇ¨Ïö©</option>
								            </select>
								
								            <!-- Íµ¨Îß§ÏùºÏûê -->
								            <div class="d-flex align-items-center">
								                <label class="col-form-label mr-2" style="min-width: 70px;">Íµ¨Îß§ÏùºÏûê</label>
								                <div class="input-group">
								                    <div class="input-group-prepend">
								                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
								                        <input type="text" class="form-control" id="dateRange" style="width: 150px;">
								                    </div>
								                </div>
								            </div>
								        </div>
								
								        <!-- Ï°∞Ìöå Î≤ÑÌäº -->
								        <input type="button" id="btn_equip_insert" class="btn btn-primary" value="Ï°∞Ìöå">
								    </div>
								</div>
								<div class="card-body">
									<div class="row mb-3">
										<div class="col-5 d-flex align-items-center">
											<p class="font-weight-bold mb-0">ÏÑ§ÎπÑ Î™©Î°ù</p>
										</div>
										<div class="col-3">
											<div class="card-tools" style="text-align: right;">
												<input type="button" id="btn_equip_add_row" class="btn btn-primary" value="ÌñâÏ∂îÍ∞Ä" style="display : none;">
												<input type="button" id="btn_equip_remove_row" class="btn btn-danger" value="ÌñâÏÇ≠Ï†ú" style="display : none;">
												<input type="button" id="btn_equip_toggleEditMode" class="btn btn-warning" value="Ï∂îÍ∞Ä & Ìé∏Ïßë">
											</div>
										</div>
										<div class="col-4">
											<div class="card-tools" style="text-align: right;">
												<input type="button" id="btn_equip_insert" class="btn btn-primary" value="DB Îì±Î°ù">
												<input type="button" id="btn_equip_update" class="btn btn-warning" value="DB ÏàòÏ†ï">
												<input type="button" id="btn_equip_delete" class="btn btn-danger" value="DB ÏÇ≠Ï†ú">
												<!-- ÏóëÏÖÄ Í∏∞Îä•Îì§ÏùÑ Î™®ÏùÄ Î™®Îã¨Ï∞Ω Ï†úÏûë ÏòàÏ†ï -->
												<input type="button" id="btn_excel" class="btn btn-success" value="ÏóëÏÖÄ">
											</div>
										</div>
									</div>
									<div id="equipGrid">
										<!-- Toast Grid Ajax -->
									</div>
								</div>
								<!-- /.card-body -->
							</div>
							<!-- /.card -->
						</div>
						<!-- /.col -->
					</div>
					<!-- /.row -->
				</div>
			<!-- /.container-fluid -->
			</section>
			<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
		<!-- Ï¢åÏ∏° Î©îÎâ¥ -->
		<footer th:replace="~{includes/footer :: footer}"></footer>
		<!-- /.Ï¢åÏ∏° Î©îÎâ¥ -->
		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
			<!-- Control sidebar content goes here -->
		</aside>
		<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->
	
	<!-- Page specific script -->
	<script th:inline="javascript">
		let equipGrid;
		let equipCurrentSelectedRowKey = null;
		let equipIsEditModeEnabled = false; 
		
		const equipUrl = '/equipment/equip';
		const excelUrl = '/ajax/excelToastTest';
		const equipDataSource = {
			api: {
				createData: {url: equipUrl, method: 'POST'},
				readData: {url: equipUrl, method: 'GET'},
				updateData: {url: equipUrl, method: 'PUT'},
				deleteData: {url: equipUrl, method: 'DELETE', headers: {'X-Delete-IDs': ''}}
			},
			contentType: 'application/json',
		};
		
		const equip_columns =  [
			{header: 'ÏÑ§ÎπÑÏΩîÎìú', name: 'EQUIPMENT_ID', width: 150},
			{header: 'ÏÑ§ÎπÑÎ™Ö', name: 'EQUIPMENT_NAME', width: 200},
			{header: 'Íµ¨ÏûÖÏùºÏûê', name: 'CREATE_DATE', width: 200},
			{header: 'ÏÇ¨Ïö©Ïó¨Î∂Ä', name: 'EQUIPMENT_STATUS', width: 100},
			{header: 'ÎπÑÍ≥†', name: 'EQUIPMENT_NOTE', width: 300}
		];

		const TextInputRenderer = function(props) {
			const el = document.createElement('input');
			el.type = 'text';
		 	el.style.width = 'calc(100% - 10px)';
		 	el.style.padding = '6px 7px';
		  	el.style.border = 'solid 1px #ddd';
		  	el.style.margin = 'auto 5px';
		  	
		  	this.el = el;
		  	this.render(props);
		}

		TextInputRenderer.prototype.getElement = function () {
			return this.el;
		}
		
		TextInputRenderer.prototype.render = function (props) {
			this.el.value = props.value;
		}
		
		const TextInputBtnRenderer = function(props) {
		    const container = document.createElement('div');
		    container.style.display = 'flex';
		    container.style.alignItems = 'center';
		    container.style.gap = '5px';
		    
		    const el = document.createElement('input');
		    el.type = 'text';
		    el.style.width = 'calc(100% - 10px)';
		    el.style.padding = '6px 7px';
		    el.style.border = 'solid 1px #ddd';
		    el.style.color = 'solid 1px #ddd';
		    el.style.marginLeft = '1px';
		    el.setAttribute('disabled', true); // ÏûÖÎ†• Î∞è ÌÅ¥Î¶≠ ÎπÑÌôúÏÑ±Ìôî
			
			container.appendChild(el);
			
			// EQUIPMENT_ID Í∏∞Ï°¥Í∞íÏùÄ ÏàòÏ†ï Î∂àÍ∞Ä Ï°∞Í±¥
			if (!(props.columnInfo.name == 'EQUIPMENT_ID'
				&& equipGrid.getValue(props.rowKey, 'isNew') == null)) {
				const button = document.createElement('button');
			    button.textContent = 'üîç';
			    button.style.border = 'solid 1px #007BFF';
			    button.style.background = 'white';
			    button.style.color = 'white';
			    button.style.padding = '6px 10px';
			    button.style.cursor = 'pointer';
			    button.style.borderRadius = '4px';
			    button.style.marginRight = '5px';
				
				container.appendChild(button);
					
				button.addEventListener('click', function() {
					const row = props.rowKey;
					const column = props.columnInfo.name;
					// props.formattedValueÎ°ú Í∞ÄÏ†∏Ïò§Î©¥ Î™®Îã¨ Îã§Ïãú ÎùÑÏö∏ Îïå Í∞íÏùÑ Î™ªÎ∞õÏïÑÏò¥.
					const value = equipGrid.getValue(row, column);
					
					switch (column) {
						case 'EQUIPMENT_ID':
							$("#equipCode").val(value);
							$("#equipRow").val(row);
							$("#equipColumn").val(column);
							
							$("#checkDuplicateCodeBtn").show();
							$("#modifyCodeBtn").hide();
							$("#saveCode").attr("disabled", true);
							$("#equipCode").attr("disabled", false);
							$("#validationWorkcenterCodeMessage").text('');
							
							$('#equipCodeAdd').modal();
						break;
					}
			    });
			}
			
		    this.el = container;
		    this.input = el;
		    this.render(props);
		}

		TextInputBtnRenderer.prototype.getElement = function () {
		    return this.el;
		}

		TextInputBtnRenderer.prototype.render = function (props) {
		    this.input.value = props.value;
		}
		
		const CheckboxRenderer = function(props) {
		    const el = document.createElement('input');
		    el.type = 'checkbox';
		    //el.checked = (props.value === 'Y');  // Ï¥àÍ∏∞Í∞í ÏßÄÏ†ï
		
			el.addEventListener('change', function() {
		        props.grid.setValue(props.rowKey, props.columnInfo.name, el.checked ? 'Y' : 'N'); // Ï¶âÏãú Í∞í ÏóÖÎç∞Ïù¥Ìä∏
		    });
		    		
		    this.el = el;
		};

		CheckboxRenderer.prototype.getElement = function() {
		    return this.el;
		};

		CheckboxRenderer.prototype.getValue = function() {
		    return this.el.checked ? 'Y' : 'N';
		};

		CheckboxRenderer.prototype.mounted = function() {
		    this.el.focus();
		};
		
		$(function () {
			grid();

			// ÏóëÏÖÄ ÏóÖÎ°úÎìú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
			$('#btn_excel_upload').on('click', function () {
				uploadExcel();
			});

			// ÏóëÏÖÄ ÏóÖÎ°úÎìúÏãú ÏàòÏ†ïÎêú Ìñâ(row)Îßå dbÏóê ÏóÖÎç∞Ïù¥Ìä∏ Ïù¥Î≤§Ìä∏
			$('#btn_db_update').on('click', function () {
				updateExcelData();
			});

			// ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
			$('#btn_excel_download').on('click', function () {
				downloadExcel();
			});

			// ÏóëÏÖÄ ÏñëÏãù Îã§Ïö¥Î°úÎìú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
			$('#btn_excel_template').on('click', function () {
				downloadExcelTemplate();
			});

		});

		function grid() {
			equipGrid = new tui.Grid({
				el: document.getElementById('equipGrid'),
				data: equipDataSource,
				scrollX: true,
				scrollY: true,
				bodyHeight: 250,
				rowHeaders: ['checkbox'],
				editingEvent: 'click',
				columns: equip_columns
			});

			equipGrid.on('failResponse', function (ev) {
				alert(JSON.parse(ev.xhr.responseText).message);
				alert("Response Ïã§Ìå®");
			});

			equipGrid.on('editingStart', function (ev) {
				const {rowKey, columnName, value} = ev;
				const rowData = equipGrid.getRow(rowKey);

				// PK ÏàòÏ†ï Î∂àÍ∞Ä && ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌñâÏùÄ ÏûëÏÑ± Í∞ÄÎä•
				//if (columnName == 'ID' && !rowData.isNew) {
				//	ev.stop();
				//}
			});
			
			equipGrid.on('click', (ev) => {
			    if (ev.targetType != "cell" || equipIsEditModeEnabled) {
					return;
				}

			    const newRowKey = ev.rowKey;

			    if (equipCurrentSelectedRowKey != null) {
			    	equipGrid.removeRowClassName(equipCurrentSelectedRowKey, 'selected-row');
			    }

			    if (equipCurrentSelectedRowKey != newRowKey) {
			    	equipGrid.addRowClassName(newRowKey, 'selected-row');
			    	equipCurrentSelectedRowKey = newRowKey;
			    } else {
			        // Í∞ôÏùÄ ÌñâÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ ÏÑ†ÌÉù Ìï¥Ï†ú
			        equipCurrentSelectedRowKey = null;
			    }
			});
		}
		
		$("#btn_equip_add_row").on("click", function () {
			const newRowKey = equipGrid.appendRow(
				{
					"EQUIPMENT_ID": '',
					"EQUIPMENT_NAME": '',
					"CREATE_DATE": '',
					"EQUIPMENT_STATUS": '',
					"EQUIPMENT_NOTE": '',
					isNew: true
				},
				{focus: true}
			);
		});
		
		$("#btn_equip_remove_row").on("click", function () {
		    const rowCount = equipGrid.getRowCount(); // ÌòÑÏû¨ Ìñâ Í∞úÏàò Í∞ÄÏ†∏Ïò§Í∏∞
		    
		    const allRows = equipGrid.getData(); // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
		    const newRows = allRows.filter(row => row.isNew); // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌñâÎßå ÌïÑÌÑ∞ÎßÅ
		    
		    if (newRows.length === 0) {
		        alert("ÏÇ≠Ï†úÌï† Ïàò ÏûàÎäî Ïã†Í∑ú ÌñâÏù¥ ÏóÜÏäµÎãàÎã§.");
		        return;
		    }

		    const lastRowKey = equipGrid.getRowAt(rowCount - 1).rowKey; // ÎßàÏßÄÎßâ ÌñâÏùò rowKey Í∞ÄÏ†∏Ïò§Í∏∞
		    equipGrid.removeRow(lastRowKey); // ÎßàÏßÄÎßâ Ìñâ ÏÇ≠Ï†ú
		});
		
		// ÏàòÏ†ï Î™®Îìú ÌÜ†Í∏Ä Î≤ÑÌäº Ïù¥Î≤§Ìä∏
		$("#btn_equip_toggleEditMode").on("click", function () {
			equipIsEditModeEnabled = !equipIsEditModeEnabled; // ÏàòÏ†ï Î™®Îìú ÏÉÅÌÉú ÌÜ†Í∏Ä
		    
		    if (equipIsEditModeEnabled) {
				$("#btn_equip_add_row").show();
				$("#btn_equip_remove_row").show();
		    } else {
		    	$("#btn_equip_add_row").hide();
				$("#btn_equip_remove_row").hide();
		    }
		    
		    if (equipIsEditModeEnabled) {
		    	equipGrid.setColumns([
					{header: 'ÏÑ§ÎπÑÏΩîÎìú', name: 'EQUIPMENT_ID', width: 150, renderer: { type: TextInputBtnRenderer }},
					{header: 'ÏÑ§ÎπÑÎ™Ö', name: 'EQUIPMENT_NAME', width: 200, editor: 'text', renderer: { type: TextInputRenderer }},
					{header: 'Íµ¨ÏûÖÏùºÏûê', name: 'CREATE_DATE', width: 200, editor: 'text', renderer: { type: TextInputRenderer }},
					{header: 'ÏÇ¨Ïö©Ïó¨Î∂Ä', name: 'EQUIPMENT_STATUS', width: 100, editor: 'text', renderer: { type: TextInputRenderer }},
					{header: 'ÎπÑÍ≥†', name: 'EQUIPMENT_NOTE', width: 300, editor: 'text', renderer: { type: TextInputRenderer }}
		        ]);
		    } else {
		    	equipGrid.finishEditing();  // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù∏ ÏÖÄ Ï¢ÖÎ£åÎ•º ÏïàÌïòÎ©¥ ÏàòÏ†ïÎ™®Îìú Ï¢ÖÎ£åÏãú Í∞íÏù¥ Ï¥àÍ∏∞Ìôî ÎêòÎ≤ÑÎ¶º
		    	equipGrid.setColumns(equip_columns);
		    }
		});
		
		$("#btn_equip_modify").on("click", function() {
			equipGrid.finishEditing();  // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù∏ ÏÖÄ Ï¢ÖÎ£åÎ•º ÏïàÌïòÎ©¥ Í∞íÏù¥ Ï¥àÍ∏∞Ìôî ÎêòÎ≤ÑÎ¶º
			
		    let createdRows = equipGrid.getModifiedRows().createdRows;
		    let updatedRows = equipGrid.getModifiedRows().updatedRows;
		    
		    // ÌïÑÏàò ÏûÖÎ†• Ïª¨Îüº
		    const requiredFields = ["EQUIPMENT_ID", "EQUIPMENT_NAME", "EQUIPMENT_STATUS"];

		    let validCreatedRows = createdRows.filter(row =>
		        requiredFields.every(field => 
		        	row[field] && row[field].trim() !== ''
		        )
		    );
		    
		    let validUpdatedRows = updatedRows.filter(row =>
		        requiredFields.every(field => 
		        	row[field] && row[field].trim() !== ''
		        )
		    );
		    
		    if (createdRows.length == 0 && updatedRows.length == 0) {
		    	alert("ÏàòÏ†ïÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
		        return;
		    }

			if (createdRows.length > 0) {
				if ((validCreatedRows.length == 0)
					|| (validCreatedRows.length != createdRows.length)) {
					alert("ÌïÑÏàòÍ∞íÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
			        return;
				}
			}
				
			if (updatedRows.length > 0 && validUpdatedRows.length == 0) {
				alert("ÌïÑÏàòÍ∞íÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
		        return;
			}
			
			equipGrid.request('modifyData');
			equipGrid.setColumns(equip_columns);
			
			equipIsEditModeEnabled = false;
	    	$("#btn_equip_add_row").hide();
			$("#btn_equip_remove_row").hide();
		});
		
		$("#btn_equip_insert").on("click", function () {
			equipGrid.request('createData');
			equipGrid.reloadData();  // Ïã§Ìå®Ïãú ÌÖåÏù¥Î∏î Î¶¨Î°úÎìú
			// GET ÏöîÏ≤≠Ïãú Îç∞Ïù¥ÌÑ∞ Î≥¥ÎÇºÎ†§Î©¥ header ÏÑ§Ï†ï
		});

		$("#btn_equip_update").on("click", function () {
			equipGrid.request('updateData');
		});

		$("#btn_equip_delete").on("click", function () {
			equipGrid.removeCheckedRows();

			// Î∞òÎìúÏãú removeCheckedRows()ÌõÑÏóê Ïã§Ìñâ ÏàúÏÑú
			// DELETEÎäî bodyÍ∞Ä ÏóÜÍ≥† urlÍ≥º headerÎßå ÏûàÏùå, Í∏∞Î≥∏Í∞í url -> urlÎåÄÏã† headerÏóê Îã¥ÏïÑ Î≥¥ÎÉÑ
			const ids = equipGrid.getModifiedRows().deletedRows.map(row => row.ID).join(',');
			dataSource.api.deleteData.headers['X-Delete-IDs'] = ids;

			equipGrid.request('deleteData');
			equipGrid.reloadData();  // Ïã§Ìå®Ïãú ÌÖåÏù¥Î∏î Î¶¨Î°úÎìú
		});
		
		// ÏóëÏÖÄ ÌååÏùº ÏóÖÎ°úÎìú Î∞è Îç∞Ïù¥ÌÑ∞ Ï∂úÎ†•
		function uploadExcel() {
			let fileInput = document.getElementById('excelFile');
			let file = fileInput.files[0];

			if (!file) {
				alert("ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
				return;
			}

			let formData = new FormData();
			formData.append("file", file);

			$.ajax({
				url: "/ajax/uploadExcel", // ÏÑúÎ≤Ñ ÏóÖÎ°úÎìú URL
				type: "POST",
				data: formData,
				processData: false,
				contentType: false,
				success: function (res) {
					console.log("ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞ : ", res);
					grid1.resetData(res); // Toast UI GridÏóê Îç∞Ïù¥ÌÑ∞ Î∞îÏù∏Îî©
				},
				error: function (err) {
					console.error("ÏóÖÎ°úÎìú Ïã§Ìå® : ", err);
					alert("ÏóëÏÖÄ ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
				}
			});
		}

		// ÏóëÏÖÄ ÌååÏùº ÏóÖÎ°úÎìúÏãú ÏàòÏ†ïÎêú Ìñâ(row)Îßå dbÏóê ÏóÖÎç∞Ïù¥Ìä∏
		function updateExcelData() {
			let fileInput = document.getElementById('excelFile');
			let file = fileInput.files[0];

			if (!file) {
				alert("ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
				return;
			}

			let formData = new FormData();
			formData.append("file", file);

			$.ajax({
				url: "/ajax/updateExcelData",
				type: "POST",
				data: formData,
				processData: false,
				contentType: false,
				success: function (res) {
					alert(res.message);
					grid1.reloadData();  // ÏóÖÎ°úÎìú ÌõÑ Í∑∏Î¶¨Îìú ÏÉàÎ°úÍ≥†Ïπ®
				},
				error: function (xhr, status, err) {
					console.error("db ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå® : ", err);
					alert("ÏóëÏÖÄ db ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
				}
			});
		}

		// ÏóëÏÖÄ ÌååÏùº Îã§Ïö¥Î°úÎìú
		function downloadExcel() {
			// testÏö© ÏóëÏÖÄ ÌååÏùº
			const sheetName = "ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞";
			const fileName = "ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞.xlsx";

			// Grid Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
			const jsonData = grid1.getData(); // getData() ÏÇ¨Ïö©
			const headers = grid1.getColumns().map(col => col.name);
			const data = jsonData.map(row => grid1.getColumns().map(col => row[col.name] || ""));

			// ÏóëÏÖÄ ÏãúÌä∏ ÏÉùÏÑ±
			const worksheet = XLSX.utils.aoa_to_sheet([headers, ...data]);

			// Ïª¨Îüº ÏûêÎèô ÎÑàÎπÑ Ï°∞Ï†ï
			const colWidths = headers.map(header => ({wch: header.length + 5}));
			worksheet['!cols'] = colWidths;

			// ÏõåÌÅ¨Î∂Å ÏÉùÏÑ±
			const workbook = XLSX.utils.book_new();
			XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);

			// ÌååÏùº Îã§Ïö¥Î°úÎìú
			XLSX.writeFile(workbook, fileName);
		}

		// ÏóëÏÖÄ ÏñëÏãù Îã§Ïö¥Î°úÎìú (test)
		function downloadExcelTemplate() {
			// Í∏âÏó¨ ÌÖåÏù¥Î∏îÎ°ú ÌÖåÏä§Ìä∏
			const tableName = prompt("Îã§Ïö¥Î°úÎìúÌï† ÌÖåÏù¥Î∏î(ÏñëÏãù)Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.", "TEST");

			if (!tableName) {
				alert("ÌÖåÏù¥Î∏î(ÏñëÏãù)Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
				return;
			}

			$.ajax({
				//url: `/ajax/downloadTemplate?tableName=${tableName}`,
				url: "/ajax/downloadTemplate?tableName=" + tableName,
				method: "GET",
				xhrFields: {
					responseType: "blob"  // Î∞îÏù¥ÎÑàÎ¶¨ Îç∞Ïù¥ÌÑ∞Î°ú ÏùëÎãµ Î∞õÍ∏∞
				},
				success: function (data) {
					// Î∞îÏù¥ÎÑàÎ¶¨ Îç∞Ïù¥ÌÑ∞Î•º URL Í∞ùÏ≤¥Î°ú Î≥ÄÌôò Î∞è ÏÉàÎ°úÏö¥ <a> (ÎßÅÌÅ¨) ÏöîÏÜå ÏÉùÏÑ±
					const url = window.URL.createObjectURL(data);
					const a = document.createElement("a");

					// Îã§Ïö¥Î°úÎìú ÏÜçÏÑ± ÏÑ§Ï†ï
					a.href = url;
					a.download = tableName + "_template.xlsx";
					//a.download = `${tableName}_template.xlsx`;

					// ÎßÅÌÅ¨Î•º ÌÅ¥Î¶≠ÌïòÏó¨ Îã§Ïö¥Î°úÎìú ÏãúÏûë
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);

					// URL Ìï¥Ï†ú
					window.URL.revokeObjectURL(url);
				},
				error: function (xhr, status, error) {
					console.error("Îã§Ïö¥Î°úÎìú Ïã§Ìå® : ", error);
				}
			});
		}

	</script>
</body>

</html>