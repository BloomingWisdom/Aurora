<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AdminLTE 3 | DataTables</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
	<!-- DataTables -->
	<link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-select/css/select.bootstrap4.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<!-- daterange picker -->
	<link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
</head>
<body class="hold-transition sidebar-mini">
	<div class="wrapper">

		<!-- 상단 메뉴 -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.상단 메뉴 -->

		<!-- 좌측 메뉴 -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.좌측 메뉴 -->
		
		<nav th:replace="~{includes/modals/commonCodeGroup :: commonCodeGroup}"></nav>
		<nav th:replace="~{includes/modals/commonCodeGroupEdit :: commonCodeGroupEdit}"></nav>
		<nav th:replace="~{includes/modals/modalCommonCode :: modalCommonCode}"></nav>
		<nav th:replace="~{includes/modals/modalCommonCodeEdit :: modalCommonCodeEdit}"></nav>

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- 콘텐츠 헤더 (Page header) -->
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>메뉴관리</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">설정</a></li>
								<li class="breadcrumb-item active">공통코드</li>
							</ol>
						</div>
					</div>
				</div>
			</section>
			<!-- /.콘텐츠 헤더 (Page header) -->
			<!-- 메인 콘텐츠 -->
			<section class="content">
				<div class="container-fluid">
					<div class="card">
						<div class="card-header">
							<h3 class="card-title">메뉴관리</h3>
<!--							<div class="card-tools">-->
<!--								<div class="d-flex">-->
<!--									<button type="button" class="btn btn-primary" id="btnAddGroup">등록</button>-->
<!--									<button type="button" class="btn btn-primary mx-1" id="btnUpdateGroup">수정</button>-->
<!--									<button type="button" class="btn btn-primary" id="btnDeleteGroup">삭제</button>-->
<!--								</div>-->
<!--							</div>-->
						</div>
						<div class="card-body">
							<table id="groupCode" class="table table-bordered table-striped">
								<!-- dataTable Ajax -->
							</table>
						</div>
					<!-- /.card-body -->
					</div>
				<!-- /.card -->
				</div>
			<!-- /.container-fluid -->
			</section>
		<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
		<!-- 좌측 메뉴 -->
		<footer th:replace="~{includes/footer :: footer}"></footer>
		<!-- /.좌측 메뉴 -->
		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
		<!-- Control sidebar content goes here -->
		</aside>
	<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->

	<!-- jQuery -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- DataTables  & Plugins -->
	<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
	<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
	<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
	<script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
	<script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
	<script src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
	<script src="../../plugins/jszip/jszip.min.js"></script>
	<script src="../../plugins/pdfmake/pdfmake.min.js"></script>
	<script src="../../plugins/pdfmake/vfs_fonts.js"></script>
	<script src="../../plugins/datatables-buttons/js/buttons.html5.min.js"></script>
	<script src="../../plugins/datatables-buttons/js/buttons.print.min.js"></script>
	<script src="../../plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
	<script src="../../plugins/datatables-select/js/dataTables.select.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../../dist/js/adminlte.min.js"></script>
	<!-- AdminLTE for demo purposes -->
	<script src="../../dist/js/demo.js"></script>
	<!-- InputMask -->
	<script src="../../plugins/moment/moment.min.js"></script>
	<script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>
	<!-- date-range-picker -->
	<script src="../../plugins/daterangepicker/daterangepicker.js"></script>
	
	<!-- Page specific script -->
	<script th:inline="javascript">
		const plusIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">'
		  			   + '<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>'
		  			   + '<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>'
					   + '</svg>';
		
		$(function () {
			groupCodeDataTable("groupCode");
		});
		
		function groupCodeDataTable(id) {
			let table = $("#" + id).DataTable({
				dom :	"<'row'<'col-sm-12 col-md-6'B><'col-sm-12 col-md-6'f>>"
									  + "<'row'<'col-sm-12'tr>>"
									  + "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
				aaSorting: [], // 초기 정렬 비활성화
				select : {
					style : 'single'
				},
				language : {
					search : "검색",
					paginate: {
		                "first" : "처음",
		                "last" : "마지막",
		                "next" : "다음",
		                "previous" : "이전"
		            },
		            zeroRecords : "검색 결과 없음"
				},
				ajax : {
					url : "/system/getMenuList",
					type:"POST",
					data : {
						depth : 1
					},
					"dataSrc": function (res) {
		                return res;
		            }
				},
				columns : [
					{
					    className: 'details-control',
						orderable: false,
					    data: null, 
					    //defaultContent: plusIcon,
					    width: '20px',
						render: function(data, type, row) {
		                    return row.TYPE === '폴더' ? plusIcon : '';
		                }
					},
					{data : "MENU_ID", title : "메뉴ID", "defaultContent": "" },
					{data : "NAME", title : "메뉴명", "defaultContent": "" },
					{data : "URL", title : "경로", "defaultContent": "" },
					{data : "ROLE", title : "접근권한", "defaultContent": "" },
					{data : "SORT_ORDER", title : "정렬순서", "defaultContent": "" },
					{data : "USE_YN", title : "사용여부", "defaultContent": "" },
					{data : "TYPE", title : "종류", "defaultContent": "" }
				],
				select: {
				    style:    'os',
				    selector: 'td:not(:first-child)'
				},
				responsive : true, 
				lengthChange : false, 
				autoWidth : false,
				buttons : [
					{
			            text: "등록",
			            action: function () {
			            }
					},
					{
			            text: "수정",
			            action: function () {
			            }
					},
					{
			            text: "삭제",
			            action: function () {
			            }
					}
				]
			}).buttons()
			  .container()
			  .appendTo('#example1_wrapper .col-md-6:eq(0)');
			  
		  $("#" + id).on('click', 'tbody td.details-control', function(e) {
	  			// dataTables select적용 시간보다 늦어야함.
	  			setTimeout(function(){
					
	  				let table = $("#" + id).DataTable();
	  				
	  				let tr = e.target.closest('tr');
	  				let row = table.row(tr);
	  				
	  				if (row.child.isShown()) {
	  					destroyChild(row);
	  				} else {
						let menu_id = row.data().MENU_ID;
						if (row.data().TYPE == '폴더') {
							createChild(row, menu_id);
						}
	  				}
	  			}, 10);
	  		});
		}
		
		function destroyChild(row) {
		    let table = $("table", row.child());
		    table.detach();
		    table.DataTable().destroy();
		 
		    row.child.hide();
		}
		
		function createChild(row, menu_id) {
		    let table = $('<table class="display" width="100%"/>');
		 
		    row.child(table).show();
			
		    let usersTable = table.DataTable({
				dom :	"<'row'<'col-sm-12 col-md-6'B><'col-sm-12 col-md-6'f>>"
					  + "<'row'<'col-sm-12'tr>>"
					  + "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
				aaSorting: [], // 초기 정렬 비활성화
				select : {
					style : 'single'
				},
				language : {
					search : "검색",
					paginate: {
		                "first" : "처음",
		                "last" : "마지막",
		                "next" : "다음",
		                "previous" : "이전"
		            },
		            zeroRecords : "검색 결과 없음"
				},
				ajax : {
					url : "/system/getMenuList",
					type:"POST",
					data : {
						menu_id : menu_id
					},
					"dataSrc": function (res) {
		                return res;
		            }
				},
				columns : [
					{
					    className: 'details-control',
						orderable: false,
					    data: null, 
			//		    defaultContent: plusIcon,
					    width: '20px',
						render: function(data, type, row) {
		                    return row.TYPE === '폴더' ? plusIcon : '';
		                }
					},
					{data : "MENU_ID", title : "메뉴ID", "defaultContent": "" },
					{data : "NAME", title : "메뉴명", "defaultContent": "" },
					{data : "URL", title : "경로", "defaultContent": "" },
					{data : "ROLE", title : "접근권한", "defaultContent": "" },
					{data : "SORT_ORDER", title : "정렬순서", "defaultContent": "" },
					{data : "USE_YN", title : "사용여부", "defaultContent": "" },
					{data : "TYPE", title : "종류", "defaultContent": "" }
				],
				select: {
				    style:    'os',
				    selector: 'td:not(:first-child)'
				},
				responsive : true, 
				lengthChange : false, 
				autoWidth : false,
				buttons : [
					{
			            text: "등록",
			            action: function () {
			            }
					},
					{
			            text: "수정",
			            action: function () {
			            }
					},
					{
			            text: "삭제",
			            action: function () {
			            }
					}
				]
			}).buttons()
			  .container()
			  .appendTo('#example1_wrapper .col-md-6:eq(0)');
			  
		  // setTimeout으로 DOM 접근 시점을 지연
		  setTimeout(function() {
		      let tableId = table.attr('id');
			  
			  $("#" + tableId).on('click', 'tbody td.details-control', function(e) {
  		  			// dataTables select적용 시간보다 늦어야함.
  		  			setTimeout(function(){
  		  				let table = $("#" + tableId).DataTable();
  		  				
  		  				let tr = e.target.closest('tr');
  		  				let row = table.row(tr);
  		  				
  		  				if (row.child.isShown()) {
  		  					destroyChild(row);
  		  				} else {
							let menu_id = row.data().MENU_ID;
							if (row.data().TYPE == '폴더') {
								createChild(row, menu_id);
							}
  		  				}
  		  			}, 10);
  		  		});
			}, 0);
		}
		
	</script>
</body>
</html>