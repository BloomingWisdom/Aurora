<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>구매발주등록</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
	<!-- DataTables -->
	<link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<!-- daterange picker -->
	<link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
	<!-- Toast Grid -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<!-- jQuery OrgChart CSS CDN -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/orgchart/5.0.0/css/jquery.orgchart.min.css"
		integrity="sha512-9A2BSSUL5eXVMWwrB8aDX8GeOOSMMVCk3fvqOplnswmo4IN4s6DW2ywpb3VCDcGCVwDc3g6S1k9T72NsCkgw5A=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />


	<style>
		.table-container {
			margin-top: 20px;
		}

		.divider {
			border-top: 4px solid #000;
			margin: 30px 0;
		}

		.btn-actions {
			display: flex;
			gap: 10px;
		}

		.hidden {
			display: none;
		}
	</style>
</head>

<body class="hold-transition sidebar-mini">
	<div class="wrapper">
		<!-- 상단 메뉴 -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.상단 메뉴 -->
		<!-- 좌측 메뉴 -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.좌측 메뉴 -->

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- 콘텐츠 헤더 (Page header) -->
			
<!-- 			<nav th:replace="~{includes/pageHeader :: pageHeader}"></nav> -->
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>발주관리</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">설정</a></li>
								<li class="breadcrumb-item active">발주관리</li>
							</ol>
						</div>
					</div>
				</div>
			</section>
			<!-- /.콘텐츠 헤더 (Page header) -->

			<section class="content">
				<div class="container-fluid">

					<!-- 첫 번째 row (구매발주) -->
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h5>구매발주</h5>
									<div class="card-tools">
										<input type="button" id="btn_add_row" class="btn btn-primary" value="행추가">
										<input type="button" id="save" class="btn btn-primary" value="저장">
										<input type="button" id="btn_delete" class="btn btn-primary" value="삭제">
									</div>
								</div>
								<div class="card-body">
									<div id="toast_single"></div>
								</div>
							</div>
						</div>
					</div>

					<!-- 구분선 -->
					<div class="divider hidden" id="divider"></div>

					<!-- 두 번째 row (구매발주 상세) -->
					<div class="row hidden" id="detail_section">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h5>구매발주 상세</h5>
									<div class="card-tools">
										<input type="button" id="btn_add_row2" class="btn btn-primary" value="행추가">
										<input type="button" id="saveDetail" class="btn btn-primary" value="저장">
										<input type="button" id="btn_delete2" class="btn btn-primary" value="삭제">
									</div>
								</div>
								<div class="card-body">
									<div id="toast_single2"></div> <!-- 구매발주 상세 영역 -->
								</div>
							</div>
						</div>
					</div>

				</div>
			</section>
			<!-- jQuery -->
			<script src="../../plugins/jquery/jquery.min.js"></script>
			<!-- Bootstrap 4 -->
			<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
			<!-- AdminLTE App -->
			<script src="../../dist/js/adminlte.min.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/notiflix@3.2.6/dist/notiflix-aio-3.2.6.min.js"></script>

			<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>

			<style>
				.selected-row {
					background-color: #d1ffd6;
				}

				.deselected-row {
					background-color: #ffd1d1;
				}
			</style>
			<!-- Page specific script -->
			<script>
			const token = $("meta[name='_csrf']").attr("content")
			const header = $("meta[name='_csrf_header']").attr("content");
			const name = $("#userName").val();
			
				$(document).ready(function () {

				});



				// Toast Grid 설정

				let grid1;
				let grid2;

				const url = 'getPurchase';
				const dataSource = {
					api: {
						createData: {url: url, method: 'POST', headers: { [header]: token } },
						readData: {url: url, method: 'POST', headers: { [header]: token }},
						updateData: {url: url, method: 'PUT', headers: { [header]: token }},
						deleteData: {url: url, method: 'DELETE', headers: {'X-Delete-IDs': ''}}
					},
					contentType: 'application/json',
				};
				const columns = [
					{header: 'P/O일자', name: 'CREATE_DATE', align: 'center', editor: 'text'},
					{header: 'P/O번호', name: 'PO_ID', align: 'center', editor: null},
					{header: '담당자', name: 'MEMBER_ID', align: 'center', editor: 'text'},
					{header: '거래처', name: 'CUSTOMER_ID', align: 'center', editor: 'text'},
					{header: '수량', name: 'PO_COUNT', align: 'center', editor: 'text'},
					{header: '금액', name: 'PO_PRICE', align: 'center', editor: 'text'},
					{header: '수정일', name: 'UPDATE_DATE', align: 'center', editor: null},
					{header: '수정자', name: 'UPDATE_MEMBER', align: 'center', editor: 'text'},
					{header: '상태', name: 'PO_STATUS', align: 'center', editor: 'text'},
					{ header: '주문번호', name: 'PO_NUM', hidden: true }
				];
				
				fetch('/getPurchase', {
				    method: 'POST',
				    headers: {
				        'Content-Type': 'application/json',
				        [header]: token
				    },
				    body: JSON.stringify({})
				})
				.then(response => response.json())
				.then(data => {
				    console.log("서버 응답 데이터:", data);
				    grid1.resetData(data);
				})
				.catch(error => console.error("데이터 불러오기 실패:", error));

				$(function () {
					initGrids();


				});


				function initGrids() {
					grid1 = new tui.Grid({
						el: document.getElementById('toast_single'),
						data: dataSource,
						scrollX: true,
						scrollY: true,
						rowHeaders: ['checkbox'],
						editingEvent: 'click',
						columns: columns,
					});

				// 구매발주 상세 리스트를 숨김 상태에서 시작
				$("#detail_section").hide();
				$("#divider").hide();

				let delRows = [];
					// 행 클릭 시 상세 리스트 보이기
					grid1.on('click', function (ev) {
						if (ev.rowKey === null) {
							return;
						}

						const selectedRow = grid1.getRow(ev.rowKey);
						if (selectedRow) {
							$("#detail_section").fadeIn(300).removeClass("hidden").addClass("visible");
							$("#divider").fadeIn(300).removeClass("hidden").addClass("visible");

							// grid2 데이터 업데이트
							dtlGrid([selectedRow]);
							//grid.resetData([selectedRow]);

						}
					});

					// 더블 클릭하면 상세 리스트 숨기기
					grid1.on('dblclick', function () {
						$("#detail_section").fadeOut(300).removeClass("visible").addClass("hidden");
						$("#divider").fadeOut(300).removeClass("visible").addClass("hidden");
						grid2.resetData([]);
					});

					// 체크박스가 활성화된 행의 index를 배열에 저장
					grid1.on('check', (ev) => {
						delRows.push(ev.rowKey);
					});
				}

				function dtlGrid(parentData) {
					console.info(parentData);

					if (grid2) {
						grid2.resetData(parentData);
					} else {

						grid2 = new tui.Grid({
							el: document.getElementById('toast_single2'),
							data: parentData,
							scrollX: true,
							scrollY: true,
							rowHeaders: ['checkbox'],
							editingEvent: 'click',
							columns: columns,
						});
					}

					grid1.on('failResponse', function (ev) {
						alert(JSON.parse(ev.xhr.responseText).message);
					});

					grid1.on('editingStart', function (ev) {
						const {rowKey, columnName, value} = ev;
						const rowData = grid1.getRow(rowKey);

						// PK 수정 불가 && 새로 추가된 행은 작성 가능
						if (columnName == 'ID' && !rowData.isNew) {
							ev.stop();
						}
					});


					grid1.on('failResponse', function (ev) {
						alert(JSON.parse(ev.xhr.responseText).message);
					});

					grid1.on('editingStart', function (ev) {
						const {rowKey, columnName, value} = ev;
						const rowData = grid1.getRow(rowKey);

						// PK 수정 불가 && 새로 추가된 행은 작성 가능
						if (columnName == 'ID' && !rowData.isNew) {
							ev.stop();
						}
					});
				}

				$("#btn_add_row").on("click", function () {
					let today = new Date();
					let year = today.getFullYear(); // 년도
					let month = String(today.getMonth() + 1).padStart(2, "0");  // 월
					let date = String(today.getDate()).padStart(2, "0");  // 날짜
					const newRowKey = grid1.appendRow(
						{
							"CREATE_DATE": year + '-' + month + '-' + date,
							//"COL_1": '',
							//"COL_2": '',
							//"COL_3": '',
							//isNew: true
						},
						{focus: true}
					);
				});

				$("#btn_add_row2").on("click", function () {
					let today = new Date();
					let year = today.getFullYear(); // 년도
					let month = String(today.getMonth() + 1).padStart(2, "0");  // 월
					let date = String(today.getDate()).padStart(2, "0");  // 날짜
					const newRowKey = grid2.appendRow(
						{
							"PO_DATE": year + '-' + month + '-' + date,
							//"COL_1": '',
							//"COL_2": '',
							//"COL_3": '',
							//isNew: true
						},
						{focus: true}
					);
				});
				
				// ✅ 저장 버튼 이벤트
				save.addEventListener('mousedown', handleSave);

				// ✅ 삭제 버튼 이벤트
				del.addEventListener('mousedown', handleDelete);

				// ✅ 체크된 행 저장 배열
				let delRows = [];
				grid1.on('check', (ev) => delRows.push(ev.rowKey));
				
				// ✅ 저장 함수
				function handleSave() {
				    grid1.blur(); // 포커스 해제

				    const modifiedRows = grid1.getModifiedRows();
				    const createdRows = modifiedRows.createdRows.map(row => ({ ...row, rowType: "insert" }));
				    const updatedRows = modifiedRows.updatedRows.map(row => ({ ...row, rowType: "update" }));
				    const deletedRows = modifiedRows.deletedRows.map(row => ({ ...row, rowType: "delete" }));

				    const allData = [...createdRows, ...updatedRows, ...deletedRows];

				    if (allData.length === 0) {
				        alert("변경된 데이터가 없습니다.");
				        return;
				    }

				    console.log("서버로 전송할 데이터:", allData);

				    $.ajax({
				        url: "/savePurchase",
				        type: 'POST',
				        contentType: "application/json",
				        data: JSON.stringify(allData),
				        beforeSend: (xhr) => xhr.setRequestHeader(header, token),
				        success: (res) => {
				            if (res == "success") {
				                showSuccess("저장 성공!", true);
				            } else {
				                showError("저장 실패");
				            }
				        },
				        error: () => showError("서버 오류 발생"),
				    });
				}

				// ✅ 삭제 함수
				function handleDelete() {
				    grid1.blur(); // 포커스 해제

				    delRows.forEach(index => {
				        grid1.setValue(index, "rowType", "delete");
				        grid1.removeRow(index);
				    });

				    delRows = []; // 삭제 목록 초기화
				}

				// 메시지
				function showSuccess(message, reload = false) {
					Notiflix.Notify.success('저장 성공!');
				}

				function showError(message) {
				   Notiflix.Notify.failure('저장 실패!');
				}
				
			/*	// 저장 이벤트
				// 데이터 저장 함수
				async function saveData() {
				    grid1.blur(); // 포커스 해제

				    const modifiedRows = grid1.getModifiedRows();
				    console.log("getModifiedRows() 반환값:", modifiedRows);

				    // 각 행 타입을 추가하여 데이터를 가공
				    const createdRows = modifiedRows.createdRows.map(row => ({ ...row, rowType: "insert" }));
				    const updatedRows = modifiedRows.updatedRows.map(row => ({ ...row, rowType: "update" }));
					const deletedRows = modifiedRows.deletedRows.map(row => ({ ...row, rowType: "delete" }));; // 삭제된 행
					const allData = [...createdRows, ...updatedRows, ...deletedRows];
					
					

					
				    // 변경된 데이터가 없으면 저장하지 않음
				    if (allData.length === 0) {
				        alert("변경된 데이터가 없습니다.");
				        return;
				    }

				    console.log("서버로 전송할 데이터:", allData);

				    try {
				        const response = await fetch('/savePurchase', {
				            method: 'POST',
				            headers: {
				                'Content-Type': 'application/json',
				                [header]: token
				            },
				            body: JSON.stringify(allData)
				        });

				        const result = await response.json();
				        console.log("서버 응답:", result);
				        alert(result.message || "저장 성공!");

				        // 데이터 다시 불러오기
				        grid1.reloadData();
				    } catch (error) {
				        console.error("저장 실패:", error);
				        alert("저장 중 오류가 발생했습니다.");
				    }
				}

				// 삭제 이벤트 처리 함수
				function deleteSelectedRows() {
				    grid1.blur(); // 포커스 해제

				    // 선택된 행 삭제
				    delRows.forEach(index => {
				        grid1.removeRow(index);
				    });

				    // 삭제 목록 초기화
				    delRows = [];
				}

				// 저장 버튼 이벤트 리스너
				save.addEventListener('mousedown', saveData);

				// 삭제 버튼 이벤트 리스너
				btn_delete.addEventListener('mousedown', deleteSelectedRows);
			*/
			</script>
</body>

</html>