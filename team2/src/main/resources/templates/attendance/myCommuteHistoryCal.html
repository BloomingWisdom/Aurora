<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AdminLTE 3 | Calendar</title>
	
	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="../plugins/fontawesome-free/css/all.min.css">
	<!-- Ion Slider -->
	<link rel="stylesheet" href="../plugins/ion-rangeslider/css/ion.rangeSlider.min.css">
	<!-- fullCalendar -->
	<link rel="stylesheet" href="../plugins/fullcalendar/main.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../dist/css/adminlte.min.css">
	<!-- daterange picker -->
	<link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
</head>
<body class="hold-transition sidebar-mini">
	<div class="wrapper">
	<!-- Content Wrapper. Contains page content -->
	
		<!-- 상단 메뉴 -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
	
		<!-- 좌측 메뉴 -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		
		<nav th:replace="~{includes/modals/leaveRequest :: leave_request}"></nav>
	
		<div class="content-wrapper">
			<!-- 콘텐츠 해더 -->
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>Calendar</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">Home</a></li>
								<li class="breadcrumb-item active">Calendar</li>
							</ol>
						</div>
					</div>
				</div>
			</section>
			<!-- /.콘텐츠 해더 -->
			
			<!-- 콘텐츠 메인 -->
			<section class="content">
				<div class="container-fluid">
					<div class="row">
					
						<!-- 캘린더 -->
						<div class="col-md-10">
							<div class="card card-primary">
								<div class="card-body p-0">
									<!-- THE CALENDAR -->
									<div id="calendar"></div>
								</div>
							</div>
						</div>
						<!-- /.캘린더 -->
						
						<div class="col-md-2">
							<!-- 유저 프로필 -->
							<div class="card card-widget widget-user">
								<div class="widget-user-header bg-info">
									<h3 class="widget-user-username" id="memberName"></h3>
									<h5 class="widget-user-desc" id="deptName"></h5>
								</div>
								<div class="widget-user-image">
									<img class="img-circle elevation-2" id="profilePreview" src="/images/default.jpg" alt="/images/default.jpg">
								</div>
								<div class="card-footer">
									<div class="row">
										<div class="col-sm-6 border-right">
											<div class="description-block">
												<h5 class="description-header">총휴가</h5>
												<span class="description-text" id="totalVacation">0</span>
											</div>
										</div>
										<div class="col-sm-6 border-right">
											<div class="description-block">
												<h5 class="description-header">잔여휴가</h5>
												<span class="description-text" id="remainingVacation">0</span>
											</div>
										</div>
									</div>
									<hr>
									<button type="button" class="btn btn-block btn-outline-primary mt-3"
											data-toggle="modal" data-target="#modal-xl">
										휴가 신청
									</button>
								</div>
							</div>
							<!-- /.유저 프로필 -->
							
							<!-- 출퇴관리 -->
							<div class="sticky-top mb-2">
								<div class="card">
									<div class="card-header">
										<h4 class="card-title">출근관리</h4>
									</div>
									<div class="card-body">
										<div class="mb-4">
											<span id="currentDateTime">날짜</span>
										</div>
										<div class="d-flex align-items-baseline">
											<h1 id="workHour"></h1><p>시간</p><h1 id="workMinute"></h1><p>분</p>
										</div>
										<div class="row margin mb-5">
											<div class="col-sm-12">
												<input id="range_6" type="text" name="range_6">
											</div>
										</div>
										<p>출근시간 : <span id = "checkInTime" class="time_display"></span> </p>
										<p>퇴근시간 : <span id = "checkOutTime" class="time_display"></span></p>
										<hr>
										<div class="row">
											<div class="col-md-6">
												<button type="button" id="checkInBtn" class="btn btn-block btn-outline-primary">출근하기</button>
											</div>
											<div class="col-md-6">
												<button type="button" id="checkOutBtn" class="btn btn-block btn-outline-primary">퇴근하기</button>
											</div>
										</div>
<!-- 										<button type="button" class="btn btn-block btn-outline-primary mt-3">로그아웃</button> -->
									</div>
								</div>
							</div>
							<!-- /.출퇴관리 -->
						</div>
					</div>
				</div>
			</section>
			<!-- /.콘텐츠 메인 -->
		<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
	
		<!-- 푸터 -->
<!-- 		<aside th:replace="~{includes/footer :: footer}"></aside> -->
	
		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark"></aside>
		
	</div>
	<!-- ./wrapper -->

	<!-- jQuery -->
	<script src="../plugins/jquery/jquery.min.js"></script>
	<!-- Bootstrap -->
	<script src="../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- jQuery UI -->
	<script src="../plugins/jquery-ui/jquery-ui.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../dist/js/adminlte.min.js"></script>
	<!-- fullCalendar 2.2.5 -->
	<script src="../plugins/moment/moment.min.js"></script>
	<script src="../plugins/fullcalendar/main.js"></script>
	<!-- AdminLTE for demo purposes -->
	<script src="../dist/js/demo.js"></script>
	<!-- Ion Slider -->
	<script src="../plugins/ion-rangeslider/js/ion.rangeSlider.min.js"></script>
	<!-- bs-custom-file-input -->
	<script src="../../plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>
	<!-- InputMask -->
	<script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>	
	<!-- date-range-picker -->
	<script src="../../plugins/daterangepicker/daterangepicker.js"></script>
	<script th:inline="javascript">
		$(function () {
			calendar();
			slider();
// 		    setInterval(updateDateTime, 1000);
			checkInOutBtnInit();
			event();
			getUserInfo();
			
			dateRangePicker();
		});
		
		function dateRangePicker() {
			// date_picker 설정 및 페이지 최초 로딩시 조회 기간 설정 (DB데이터의 최대에서 최소일자)
			$('#reservation').daterangepicker({
				locale: {
					"separator": " ~ ",
					"format": 'YYYY-MM-DD',
					"applyLabel": "선택",
			     	"cancelLabel": "취소",
			     	"daysOfWeek": ["일", "월", "화", "수", "목", "금", "토"], 
			     	"monthNames": ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
			      	"firstDay": 1
// 					"minDate": "-1M",
// 					"maxDate": "+1M"
			    },
			});
			$("#reservation").attr("readonly",true); 
		}

		function event() {
			$("#checkInBtn").on("click", function() {
				checkBtn('checkIn');
			});
			
			$("#checkOutBtn").on("click", function() {
				checkBtn('checkOut');
			});
		}
		
		function checkInOutBtnInit() {
			$.ajax({
	            type : "POST",
	            url : "/attendance/getMyCommuteHistory",
	            data : {
					isToday : 'Y'
				},
	            success : function(res){
					if (res.length == 0) {
						return;	
					}
					
					let checkInTime = res[0].COMMUTE_CHECK_IN_TIME;
					if (checkInTime != null) {
						disabledBtn('checkInBtn');
						$("#checkInTime").text(checkInTime);
					}
					
					let checkOutTime = res[0].COMMUTE_CHECK_OUT_TIME;
					if (checkOutTime != null) {
						disabledBtn('checkOutBtn');
						$("#checkOutTime").text(checkOutTime);
					}
	            },
	            error : function(XMLHttpRequest, textStatus, errorThrown){
	                console.log("checkInOutBtnInit() ajax 실패");
	            }
	        });
		}
		
		function disabledBtn(id) {
			$("#" + id).attr("disabled", true);
			$("#" + id).removeClass("btn-outline-primary");
			$("#" + id).addClass("btn-primary");
		}
		
		function checkBtn(type) {
			let message = "";

			switch (type) {
				case "checkIn": message = '출근 하시겠습니까?'; break;
				case "checkOut": message = '퇴근 하시겠습니까?'; break;
			}
			
			if (!confirm(message)) {
				return;
			}
						
			$.ajax({
	            type : "POST",
	            url : "/attendance/insertCheckTime",
	            data : {
					type : type
				},
	            success : function(res){
					alert(res.result);
					               		
                	if (res.resultCode == 1) {
						location.reload();
                	}
	            },
	            error : function(XMLHttpRequest, textStatus, errorThrown){
	                console.log("checkBtn() ajax 실패");
	            }
	        });
		}
		
		function updateDateTime() {
			$("#currentDateTime").text(new Date().toLocaleString());
	    }
		
		function slider() {
			$.ajax({
	            type : "POST",
	            url : "/attendance/getWeekendTotalWorkHour",
	            data : {},
	            success : function(res){
					/* ION SLIDER */
					$('#range_6').ionRangeSlider({
						min     : 0,	//슬라이더 최소값
						max     : 52,	//슬라이더 최대값
						from    : res,	//위치 값
						type    : 'single',
						step    : 1,
						postfix : '시간',
						prettify: false,
						hasGrid : false,
						readOnly: true,
					})

					$('#range_6').parent().css('pointer-events', 'none');
					
					let hours = Math.floor(res);
				    let minutes = Math.round((res - hours) * 60);
				    $("#workHour").text(hours);
				    $("#workMinute").text(minutes);
	            },
	            error : function(XMLHttpRequest, textStatus, errorThrown){
	                console.log("slider() ajax 실패");
	            }
	        });
		}
		
		function calendar() {
			let Calendar = FullCalendar.Calendar;
			let calendarEl = document.getElementById('calendar');
			
			$.ajax({
	            type : "POST",
	            url : "/attendance/getMyCommuteHistory",
	            data : {},
	            success : function(res){
					let events = [];
					
					res.forEach(function(el) {
						let check_in_dt = el.COMMUTE_CHECK_IN_DATE + ' ' + el.COMMUTE_CHECK_IN_TIME;
						let check_out_dt = el.COMMUTE_CHECK_OUT_DATE + ' ' + el.COMMUTE_CHECK_OUT_TIME;
						
						events.push({
		                    title: "출근",
		                    start: check_in_dt,
		                    backgroundColor: '#0073b7'
		                });
						
						events.push({
		                    title: "퇴근",
		                    start: check_out_dt,
		                    backgroundColor: '#00c0ef'
		                });
					});
					
					let calendar = new Calendar(calendarEl, {
						locale: 'kor',
						headerToolbar: {
							left  : 'prev,next today',
							center: 'title',
							right : 'dayGridMonth,timeGridWeek,timeGridDay'
						},
						themeSystem: 'bootstrap',
						events: events,
						contentHeight: 700
					});
					
					calendar.render();
	            },
	            error : function(XMLHttpRequest, textStatus, errorThrown){
	                console.log("calendar() ajax 실패");
	            }
	        });
		}
		
		function getUserInfo() {
			$.ajax({
	            type : "POST",
	            url : "/attendance/getUserInfo",
	            data : {},
	            success : function(res){
	            	if (res.length != 0) {
		            	$("#deptName").text(res[0].DEPT_NAME);
		            	$("#memberName").text(res[0].NAME);
		            	
		            	let img = "";
		            	if (res[0].PROFILE_PIC == null || res[0].PROFILE_PIC == "") {
		            		img = '/images/default.jpg';
		            	} else {
		            		img = "/images/" + res[0].PROFILE_PIC;
		            	}
		            	$("#profilePreview").attr("src", img);
	            	}
	            },
	            error : function(XMLHttpRequest, textStatus, errorThrown){
	                console.log("getUserInfo() ajax 실패");
	            }
	        });
		}
		/*
		$(document).ready(function () {
			$.ajax({
		        type : "POST",
		        url : "/getMyLeave",
		        data : {},
		        success : function(res){
					$("#totalVacation").text(res.TOTAL_DAYS);
					$("#usedVacation").text(res.USED_DAYS);
					$("#remainingVacation").text(res.REMAINING_DAYS);
		        },
		        error : function(XMLHttpRequest, textStatus, errorThrown){
		            console.log("getUserInfo() ajax 실패");
		        }
		    });
		
			$.ajax({
				type : "POST",
				url: "/getLeaveType",
				data: {},
				success : function(res){
					var selectBox = $("#leaveType");

	                selectBox.empty();

	                res.forEach(function (item) {
	                    var option = $("<option></option>")
	                        .val(item.LEAVE_TYPE_ID)
	                        .text(item.CODE_NAME + (item.CODE_NAME ? ` (code: ${item.LEAVE_TYPE_ID})` : ''));
	                    selectBox.append(option);
	                });
				}
			});
			
			$('#submitBtn').on('click', function () {
				let reservation = $("#reservation").val();
				let days = reservation.split('~').map(day => day.trim());
				$('#startDate').val(days[0]);
				$('#endDate').val(days[1]);
			});
		});
		*/
	</script>
</body>
</html>
