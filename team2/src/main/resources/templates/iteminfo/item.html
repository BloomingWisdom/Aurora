<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
	<title>AdminLTE 3 | DataTables</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<!-- Toast Grid -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />

	<!-- jQuery -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../../dist/js/adminlte.min.js"></script>
	<!-- Toast Grid -->
	<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>
</head>
<body class="hold-transition sidebar-mini">
	<div class="wrapper">

		<!-- 상단 메뉴 -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>

		<!-- 좌측 메뉴 -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>

		<nav th:replace="~{includes/modals/itemCodeAdd :: itemCodeAdd}"></nav>

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- 콘텐츠 헤더 (Page header) -->
			<nav th:replace="~{includes/pageHeader :: pageHeader}"></nav>
			
			<!-- 메인 콘텐츠 -->
			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<div class="d-flex justify-content-between align-items-center">
								        <div class="d-flex align-items-center">
								            <!-- 회사명 -->
								            <label class="col-form-label" style="min-width: 70px">회사</label>
											<select class="equip3 form-control mr-3" name="equip3" style="min-width: 120px;" >
								                <option selected="selected" disabled>회사명(미구현)</option>
								                <option>A 회사</option>
								                <option>B 회사</option>
								            </select>

											<!-- 품목유형 -->
								            <label class="col-form-label" style="min-width: 70px">품목유형</label>
											<select class="equip3 form-control mr-3" name="equip3" style="min-width: 120px;" >
								                <option selected="selected" disabled>품목유형(미구현)</option>
								                <option>전체</option>
								                <option>반제품</option>
								                <option>완제품</option>
								            </select>

											<!-- 품목분류 -->
								            <label class="col-form-label" style="min-width: 70px">품목분류</label>
											<select class="equip3 form-control mr-3" name="equip3" style="min-width: 120px;" >
								                <option selected="selected" disabled>대분류(미구현)</option>
								                <option>전체</option>
								                <option>반제품</option>
								                <option>완제품</option>
											</select>
											<select class="equip3 form-control mr-3" name="equip3" style="min-width: 120px;" >
								                <option selected="selected" disabled>소분류(미구현)</option>
								                <option>전체</option>
								                <option>반제품</option>
								                <option>완제품</option>
								            </select>
								
											<!-- 품목 -->
								            <label class="col-form-label" style="min-width: 70px">품목</label>
											<select class="equip3 form-control mr-3" name="equip3" style="min-width: 120px;" >
								                <option selected="selected" disabled>품목명(미구현)</option>
								                <option>A 품목</option>
								                <option>B 품목</option>
								            </select>
											
								            <!-- 사용여부 -->
								            <label class="col-form-label mr-2" style="min-width: 70px">사용여부</label>
								            <select class="equip3 form-control mr-3" name="equip3" style="min-width: 120px;" >
								                <option selected="selected" disabled>사용여부(미구현)</option>
								                <option>사용</option>
								                <option>미사용</option>
								            </select>
								        </div>
								
								        <!-- 조회 버튼 -->
								        <input type="button" id="btn_item_insert" class="btn btn-primary" value="조회">
								    </div>
								</div>
								<div class="card-header">
									<div class="row">
										<div class="col-6">
											<p class="font-weight-bold" style="margin-bottom: 0px; padding-top: 8px;">품목 목록</p>
										</div>
										<div class="col-6">
											<div class="card-tools" style="text-align: right;">
												<input type="button" id="btn_item_add_row" class="btn btn-primary" value="신규">
<!--												<input type="button" id="btn_item_remove_row" class="btn btn-primary" value="행삭제" style="display : none;">-->
												<input type="button" id="btn_item_toggleEditMode" class="btn btn-primary" value="편집">
												<input type="button" id="btn_item_modify" class="btn btn-primary" value="저장">
												<input type="button" id="btn_item_delete" class="btn btn-primary" value="삭제">
											</div>
										</div>
									</div>
								</div>
								<div class="card-body" id="itemGrid">
									<!-- Toast Grid Ajax -->
								</div>
							<!-- /.card-body -->
							</div>
						<!-- /.card -->
						</div>
					<!-- /.col -->
					</div>
				<!-- /.row -->
				</div>
			<!-- /.container-fluid -->
			</section>
		<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
		<!-- 좌측 메뉴 -->
		<footer th:replace="~{includes/footer :: footer}"></footer>
		<!-- /.좌측 메뉴 -->
		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
		<!-- Control sidebar content goes here -->
		</aside>
	<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->
	
	<style>
	    .selected-row {
	        background-color: #d1ffd6;
	    }
	    .deselected-row {
	        background-color: #ffd1d1;
	    }
		.modal-custom-size {
			max-width: 1300px;
		}
	</style>
	
	<!-- Page specific script -->
	<script th:inline="javascript">
		let itemGrid = null;
		const itemUrl = '/iteminfo/item';
		const itemDataSource = {
			api: {
				createData: {url: itemUrl, method: 'POST'},
			    readData: {url: itemUrl, method: 'GET'},
				modifyData: { url: itemUrl, method: 'PUT' },
				deleteData: {url: itemUrl, method: 'DELETE', headers: {'X-Delete-IDs': ''}}
			},
			contentType: 'application/json',
	    };
		let itemCurrentSelectedRowKey = null;
		let itemIsEditModeEnabled = false; 
		const item_columns = [
            {header: '품목 코드', name: 'ITEM_ID', align: 'center', editor: null},
            {header: '품목명', name: 'ITEM_NAME', align: 'left', editor: null},
            {header: '품목 유형', name: 'ITEM_TYPE', align: 'left', editor: null},
            {header: '품목 대분류', name: 'MAIN_NAME', align: 'left', editor: null},
            {header: '품목 소분류', name: 'SUB_NAME', align: 'left', editor: null},
			{
			    header: '사용여부', 
			    name: 'USE_YN', 
			    align: 'center',
			    formatter: function({value}) {
			        return `<input type="checkbox" ${value === 'Y' ? 'checked' : ''} />`;
			    }
			},
            {header: '기준단위', name: 'ITEM_UNIT', align: 'center', editor: null},
            {header: '회사명', name: 'CLIENT_NAME', align: 'center', editor: null},
            {header: '단가', name: 'ITEM_COST', align: 'center', editor: null},
            {header: '입고검사', name: 'INB_INSP', align: 'center', editor: null},
            {header: '창고명', name: 'WAREHOUSE_NAME', align: 'center', editor: null},
            {header: '안전재고', name: 'SAFETY_INVENTORY', align: 'center', editor: null},
            {header: '비고', name: 'DESCRIPTION', align: 'center', editor: null},
        ];
		
		const TextInputRenderer = function(props) {
			const el = document.createElement('input');
			el.type = 'text';
		 	el.style.width = 'calc(100% - 10px)';
		 	el.style.padding = '6px 7px';
		  	el.style.border = 'solid 1px #ddd';
		  	el.style.margin = 'auto 5px';
		  	
		  	this.el = el;
		  	this.render(props);
		}

		TextInputRenderer.prototype.getElement = function () {
			return this.el;
		}
		
		TextInputRenderer.prototype.render = function (props) {
			this.el.value = props.value;
		}
		
		const TextInputBtnRenderer = function(props) {
		    const container = document.createElement('div');
		    container.style.display = 'flex';
		    container.style.alignItems = 'center';
		    container.style.gap = '5px';
		    
		    const el = document.createElement('input');
		    el.type = 'text';
		    el.style.width = 'calc(100% - 10px)';
		    el.style.padding = '6px 7px';
		    el.style.border = 'solid 1px #ddd';
		    el.style.color = 'solid 1px #ddd';
		    el.style.marginLeft = '1px';
		    el.setAttribute('disabled', true); // 입력 및 클릭 비활성화
			
			container.appendChild(el);
			
			
		    this.el = container;
		    this.input = el;
		    this.render(props);
		}

		TextInputBtnRenderer.prototype.getElement = function () {
		    return this.el;
		}

		TextInputBtnRenderer.prototype.render = function (props) {
		    this.input.value = props.value;
		}
		
		const CheckboxRenderer = function(props) {
		    const el = document.createElement('input');
		    el.type = 'checkbox';
		    el.checked = (props.value === 'Y');  // 초기값 지정
		
			el.addEventListener('change', function() {
		        props.grid.setValue(props.rowKey, props.columnInfo.name, el.checked ? 'Y' : 'N'); // 즉시 값 업데이트
		    });
		    		
		    this.el = el;
		};

		CheckboxRenderer.prototype.getElement = function() {
		    return this.el;
		};

		CheckboxRenderer.prototype.getValue = function() {
		    return this.el.checked ? 'Y' : 'N';
		};

		CheckboxRenderer.prototype.mounted = function() {
		    this.el.focus();
		};

		$(function () {
			itemInit();
		});
		
		function itemInit() {
			itemGrid = new tui.Grid({
		        el: document.getElementById('itemGrid'),
		        data: itemDataSource,
		        scrollX: true,
		        scrollY: true,
		        bodyHeight: 250,
		        rowHeaders: ['checkbox'],
				editingEvent: 'click',
		        columns: item_columns,
		    });

		    itemGrid.on('failResponse', function(ev) {
		        alert(JSON.parse(ev.xhr.responseText).message);
				alert("Response 실패");
		    });
			
			itemGrid.on('editingStart', function(ev) {
			    const {rowKey, columnName, value} = ev;
			    const rowData = itemGrid.getRow(rowKey);
				
				// PK 수정 불가 && 새로 추가된 행은 작성 가능
// 				if (columnName == 'ITEM_ID' && !rowData.isNew) {
// 					ev.stop();
// 				}
			});
			
			itemGrid.on('click', (ev) => {
			    if (ev.targetType != "cell" || itemIsEditModeEnabled) {
					return;
				}

			    const newRowKey = ev.rowKey;

			    if (itemCurrentSelectedRowKey != null) {
			        itemGrid.removeRowClassName(itemCurrentSelectedRowKey, 'selected-row');
			    }

			    if (itemCurrentSelectedRowKey != newRowKey) {
			        itemGrid.addRowClassName(newRowKey, 'selected-row');
			        itemCurrentSelectedRowKey = newRowKey;
			    } else {
			        // 같은 행을 클릭한 경우 선택 해제
			        itemCurrentSelectedRowKey = null;
			    }
			});
		}
		
		// 수정 모드 토글 버튼 이벤트
		$("#btn_item_toggleEditMode").on("click", function () {
		    itemIsEditModeEnabled = !itemIsEditModeEnabled; // 수정 모드 상태 토글 
		    
		    if (itemIsEditModeEnabled) {
		        itemGrid.setColumns([
		        	{header: '품목 코드', name: 'ITEM_ID', align: 'center', renderer: { type: TextInputBtnRenderer }},
		            {header: '품목명', name: 'ITEM_NAME', align: 'left', editor: 'text', renderer: { type: TextInputRenderer }},
		            {header: '품목 유형', name: 'ITEM_TYPE', align: 'left', editor: 'text', renderer: { type: TextInputRenderer }},
		            {header: '품목 대분류', name: 'MAIN_NAME', align: 'left', editor: 'text', renderer: { type: TextInputRenderer }},
		            {header: '품목 소분류', name: 'SUB_NAME', align: 'left', editor: 'text', renderer: { type: TextInputRenderer }},
				    {
				        header: '사용여부',
				        name: 'USE_YN',
				        align: 'center',
				        formatter: function({value}) {
				            return `<input type="checkbox" ${value == 'Y' ? 'checked' : ''} />`;
				        },
				        renderer: { type: CheckboxRenderer }
				    },
		            {header: '기준단위', name: 'ITEM_UNIT', align: 'left', editor: 'text', renderer: { type: TextInputRenderer }},
		            {header: '회사명', name: 'CLIENT_NAME', align: 'left', editor: 'text', renderer: { type: TextInputRenderer }},
		            {header: '단가', name: 'ITEM_COST', align: 'left', editor: 'text', renderer: { type: TextInputRenderer }},
		            {header: '입고검사', name: 'INB_INSP', align: 'left', editor: 'text', renderer: { type: TextInputRenderer }},
		            {header: '창고명', name: 'WAREHOUSE_NAME', align: 'center', renderer: { type: TextInputBtnRenderer }},
		            {header: '안전재고', name: 'SAFETY_INVENTORY', align: 'center', renderer: { type: TextInputBtnRenderer }},
		        ]);
		    } else {
		        itemGrid.finishEditing();  // 현재 편집 중인 셀 종료를 안하면 수정모드 종료시 값이 초기화 되버림
		        itemGrid.setColumns(item_columns);
		    }
		});

		// 수정 모드 토글 버튼 이벤트
		$("#btn_item_add_row").on("click", function () {
		    $("#itemCodeAdd").modal("show");
		});

		// $("#btn_item_add_row").on("click", function () {
		   // const newRowKey = itemGrid.appendRow(
		     //   {
		      //  	"ITEM_ID": '',
		        //	"ITEM_NAME": '',
		       // 	"ITEM_TYPE": '',
		        //	"MAIN_NAME": '',
		        //	"SUB_NAME": '',
		        //	"USE_YN": 'N',
		   //     	"ITEM_UNIT": '',
		     //   	"CLIENT_NAME": '',
		       // 	"ITEM_COAST": '',
		     //   	"INB_INSP": '',
		       // 	"WAREHOUSE_NAME": '',
		       // 	"SAFETY_INVENTORY": '',
		      //      isNew: true
		    //    },
		    //    {focus: true}
		 //   );
	//	});
		
		$("#btn_item_remove_row").on("click", function () {
		    const rowCount = itemrGrid.getRowCount(); // 현재 행 개수 가져오기
		    
		    const allRows = itemGrid.getData(); // 전체 데이터 가져오기
		    const newRows = allRows.filter(row => row.isNew); // 새로 추가된 행만 필터링
		    
		    if (newRows.length === 0) {
		        alert("삭제할 수 있는 신규 행이 없습니다.");
		        return;
		    }

		    const lastRowKey = itemGrid.getRowAt(rowCount - 1).rowKey; // 마지막 행의 rowKey 가져오기
		    itemGrid.removeRow(lastRowKey); // 마지막 행 삭제
		});

		$("#btn_item_modify").on("click", function() {
			itemGrid.finishEditing();  // 현재 편집 중인 셀 종료를 안하면 값이 초기화 되버림
			
		    let createdRows = itemGrid.getModifiedRows().createdRows;
		    let updatedRows = itemGrid.getModifiedRows().updatedRows;
		    
		    // 필수 입력 컬럼
		    const requiredFields = ["ITEM_ID", "ITEM_NAME", "ITEM_TYPE", "MAIN_NAME", "SUB_NAME"];

		    let validCreatedRows = createdRows.filter(row =>
		        requiredFields.every(field => 
		        	row[field] && row[field].trim() !== ''
		        )
		    );
		    
		    let validUpdatedRows = updatedRows.filter(row =>
		        requiredFields.every(field => 
		        	row[field] && row[field].trim() !== ''
		        )
		    );
		    
		    if (createdRows.length == 0 && updatedRows.length == 0) {
		    	alert("수정된 데이터가 없습니다.");
		        return;
		    }

			if (createdRows.length > 0) {
				if ((validCreatedRows.length == 0)
					|| (validCreatedRows.length != createdRows.length)) {
					alert("필수값을 모두 입력해주세요.");
			        return;
				}
			}
				
			if (updatedRows.length > 0 && validUpdatedRows.length == 0) {
				alert("필수값을 모두 입력해주세요.");
		        return;
			}
			
			itemGrid.request('modifyData');
			itemGrid.setColumns(item_columns);
			
			itemIsEditModeEnabled = false;
	    	$("#btn_item_add_row").hide();
			$("#btn_item_remove_row").hide();
		});
		
        $("#btn_item_delete").on("click", function() {
			itemGrid.removeCheckedRows();
			
			// 반드시 removeCheckedRows()후에 실행 순서
			// DELETE는 body가 없고 url과 header만 있음, 기본값 url -> url대신 header에 담아 보냄
			const ids = itemGrid.getModifiedRows().deletedRows
				.map(row => encodeURIComponent(row.ITEM_ID))  // 한글 변환
				.join(',');
			itemDataSource.api.deleteData.headers['X-Delete-IDs'] = ids;
			
		    itemGrid.request('deleteData');
			itemGrid.reloadData();  // 실패시 테이블 리로드
		});
		
		$(document).ready(function () {
			
			$.ajax({
				url: '/ajax/getMesCommonCode',
				method: 'POST',
				success: function (data) {

					function mesCommonCodeByGroup(dataArray) {
						let groupedData = {};
						dataArray.forEach(item => {
							if (!groupedData[item.MAIN_ID]) {
								groupedData[item.MAIN_ID] = [];
							}
							groupedData[item.MAIN_ID].push(item);
						});
						return groupedData;
					}

					function populateSelectBox(selectBoxId, dataArray, placeholder) {
						let selectBox = $(selectBoxId);
						selectBox.empty();
						selectBox.append(`<option selected disabled>${placeholder}</option>`);
						dataArray.forEach(item => {
							let option = $('<option></option>')
								.val(item.SUB_ID)
								.text(item.SUB_ID + (item.SUB_NAME ? ` (${item.SUB_NAME})` : ''));
							selectBox.append(option);
						});
					}

					let groupedData = mesCommonCodeByGroup(data);

					if (groupedData["MATL"]) {
						populateSelectBox("#ITEM_TYPE", groupedData["MATL"], "유형선택");
					}

					if (groupedData["UNIT"]) {
						populateSelectBox("#ITEM_UNIT", groupedData["UNIT"], "단위선택");
					}

				},
				error: function (xhr, status, error) {
					console.error("Error fetching data:", error);
				}
			});
		});			
	</script>
</body>
</html>