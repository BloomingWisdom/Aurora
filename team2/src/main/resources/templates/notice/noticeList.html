<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>공지사항</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
	<!-- DataTables -->
	<link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<!-- daterange picker -->
	<link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
</head>

<body class="hold-transition sidebar-mini">
	<div class="wrapper">

		<!-- 상단 메뉴 -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.상단 메뉴 -->

		<!-- 좌측 메뉴 -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.좌측 메뉴 -->

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- 콘텐츠 헤더 -->
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>공지사항</h1>
						</div>
					</div>
				</div>
			</section>

			<!-- 메인 콘텐츠 -->
			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">공지사항 목록</h3>
									<div class="card-tools">
										<!-- 관리자만 작성 버튼 표시 -->
										<button id="btnAddNotice" class="btn btn-primary" style="display:none;"
											onclick="addNotice()">작성</button>
									</div>
								</div>

								<div class="modal fade" id="addNoticeModal" tabindex="-1"
									aria-labelledby="addNoticeModalLabel" aria-hidden="true">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title" id="addNoticeModalLabel">공지사항 작성</h5>
												<button type="button" class="btn-close" data-bs-dismiss="modal"
													aria-label="Close"></button>
											</div>
											<div class="modal-body">
												<form id="addNoticeForm">
													
													<div class="mb-3">
														<label for="noticeTitle" class="form-label">제목</label>
														<input type="text" class="form-control" id="noticeTitle"
															required>
													</div>
													<div class="mb-3">
														<label for="noticeContent" class="form-label">내용</label>
														<textarea class="form-control" id="noticeContent" rows="4"
															required></textarea>
													</div>
													<button type="submit" class="btn btn-primary">저장</button>
												</form>
											</div>
										</div>
									</div>
								</div>
		
								<!-- /.card-header -->
								<div class="card-body">
									<table id="noticeTable" class="table table-bordered table-striped">
										

									</table>
								</div>
								<!-- /.card-body -->
							</div>
							<!-- /.card -->
						</div>
						<!-- /.col -->
					</div>
					<!-- /.row -->
				</div>
				<!-- /.container-fluid -->
			</section>
			<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->

		<footer th:replace="~{includes/footer :: footer}"></footer>

	</div>
	<!-- ./wrapper -->

	<!-- JavaScript -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
	<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
	<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
	<script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
	<script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
	<script src="../../dist/js/adminlte.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

	<!-- Page specific script -->
	<script th:inline="javascript">
		const isAdmin = true; // 관리자 여부 (서버에서 가져온 데이터로 설정)
		const notices = []; // 서버에서 공지사항 데이터를 가져올 배열

		/* $(function () {
			// 관리자 권한에 따라 작성 버튼 표시
			if (isAdmin) {
				$("#btnAddNotice").show();
			}

			// 공지사항 데이터 테이블 초기화
			$("#noticeTable").DataTable({
				data: notices,
				columns: [
					{data: "NOTICE_ID"},
					{data: "NAME"},
					{data: "SUBJECT"},
					{data: "CONTENT"},
					{
						data: null,
						render: function (data) {
							return isAdmin ? `<button class="btn btn-warning btn-sm" onclick="editNotice('${data.noticeId}')">수정</button>` : "-";
						}
					},
					{
						data: null,
						render: function (data) {
							return isAdmin ? `<button class="btn btn-danger btn-sm" onclick="deleteNotice('${data.noticeId}')">삭제</button>` : "-";
						}
					}
				]
			});

			// 서버에서 공지사항 데이터 가져오기
			fetchNotices();
		}); */

		function fetchNotices() {
			// AJAX 요청으로 공지사항 데이터를 가져옵니다.
			$.ajax({
				url: '/api/notice',
				method: 'GET',
				success: function (data) {
					const table = $("#noticeTable").DataTable();
					table.clear().rows.add(data).draw();
				}
			});
		}

		function addNotice() {
			const Admin = true; // 관리자 여부 (서버에서 가져온 데이터로 설정)
			// 관리자 권한에 따라 작성 버튼 표시
			if (Admin) {
				$("#btnAddNotice").show();
			}
			
			
			// 공지사항 작성 로직 구현
			alert("공지사항 작성 기능 구현.");
		}

		function editNotice(noticeId) {
			// 공지사항 수정 로직 구현
			alert("수정할 공지사항 ID: " + noticeId);
		}

		function deleteNotice(noticeId) {
			if (confirm("정말 삭제하시겠습니까?")) {
				// 공지사항 삭제 로직 구현
				$.ajax({
					url: `/api/notice/${noticeId}`,
					method: 'DELETE',
					success: function () {
						fetchNotices();
					}
				});
			}
		}

	</script>


	<script>
		function addNotice() {
			$('#addNoticeModal').modal('show');
		}

		$('#addNoticeForm').on('submit', function (event) {
			event.preventDefault(); // 기본 제출 동작 방지

			const title = $('#noticeTitle').val();
			const content = $('#noticeContent').val();

			$.ajax({
				url: '/api/notice/createNotice',
				method: 'POST',
				data: {
					title: title,
					content: content
				},
				success: function (response) {
					alert(response); // 서버에서 받은 메시지 표시
					fetchNotices(); // 공지사항 목록 새로고침
					$('#addNoticeModal').modal('hide');
				},

			});
		});
	</script>

	<script>
		document.getElementById("addNoticeForm").addEventListener("submit", function (event) {
			event.preventDefault(); // 기본 폼 제출 방지

			// 폼 데이터 수집
// 			var noticeAuthor = document.getElementById("noticeAuthor").value;
			var noticeTitle = document.getElementById("noticeTitle").value;
			var noticeContent = document.getElementById("noticeContent").value;

			// 서버로 전송할 데이터 객체 만들기
			var data = new FormData();
// 			data.append("noticeAuthor", noticeAuthor);
			data.append("noticeTitle", noticeTitle);
			data.append("noticeContent", noticeContent);

			// AJAX 요청 (POST)
			fetch('/createNotice', {
				method: 'POST',
				body: data
			})
				.then(response => response.json()) // 서버에서 JSON 응답을 받음
				.then(data => {
					if (data.success) {
						alert('공지사항이 등록되었습니다.');
						$('#addNoticeModal').modal('hide'); // 모달 숨기기
						location.reload(); // 페이지 새로 고침 (공지사항 목록 갱신)
					} else {
						alert('공지사항 등록에 실패했습니다.');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('공지사항 등록 중 오류가 발생했습니다.');
				});
		});
	</script>




	<script th:inline="javascript">
		$(function () {
			const Admin = true; // 관리자 여부 (서버에서 가져온 데이터로 설정)
			// 관리자 권한에 따라 작성 버튼 표시
			if (Admin) {
				$("#btnAddNotice").show();
			}

			// dateRangePicker() 실행 후에 date 받아올 수 있음!!!
			/*	let date = $("#reservation").val().split(' ~ ');*/
			dataTable('noticeTable', false);
		});

		$("#btnSearch").on("click", function () {
			/*let date = $("#reservation").val().split(' ~ ');*/
			dataTable('noticeTable', date, true);
		});

		function dataTable(tableId,
			/*date,*/ isUpdate) {
			// 기존 테이블 삭제
			if (isUpdate) {
				$("#" + tableId).DataTable().destroy();
			}

			$("#" + tableId).DataTable({
				aaSorting: [], // 초기 정렬 비활성화
				// 버튼 위치 조절
				/*dom: "<'row'<'col-sm-12 col-md-6'B><'col-sm-12 col-md-6'f>>"
					+ "<'row'<'col-sm-12'tr>>"
					+ "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
				language: {
					search: "검색",
					paginate: {
						"first": "처음",
						"last": "마지막",
						"next": "다음",
						"previous": "이전"
					},
					zeroRecords: "검색 결과 없음" 
				},*/
				language : {
					zeroRecords: "검색 결과 없음" 
									},
				ajax: {
					url: "/getNoticeList",
					type: "POST",
					/*data : {
						startDate : date[0],					
						endDate : date[1]
					},*/
					"dataSrc": function (res) {
							                return res;
							            }
					
				},
				columns: [
//					{data: "NOTICE_ID", title: "ID", "defaultContent": ""},
					{data: "NUM", title: "순번", "defaultContent": ""},
					{data: "NAME", title: "작성자", "defaultContent": ""},
					{data: "SUBJECT", title: "제목", "defaultContent": ""},
					{data: "CONTENT", title: "내용", "defaultContent": "", render: function (data, type, row) {
	                    // 40자까지만 표시하고 "더보기" 링크 추가
	                    return `<a href="#" class="content-link" data-id="${row.ID}">${data.slice(0, 40)}...</a>`;
	                }},
					{data: "CREATE_TIME", title: "작성일", "defaultContent": ""}
				]
		
			})
			
		}
	</script>
</body>

</html>