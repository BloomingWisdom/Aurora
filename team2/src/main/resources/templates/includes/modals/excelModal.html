<!-- 모달창 -->
<div class="modal fade" id="excelModal" th:fragment="excelModal">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<!-- 모달창 헤더 -->
			<div class="modal-header">
				<h4 class="modal-title">엑셀</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<!-- /.모달창 헤더 -->
			<!-- 모달창 바디 -->
			<div class="modal-body">
			    <div class="card-body">
			        <div class="form-group">
			            <div class="d-flex justify-content-between align-items-center mb-3">
			                <p class="text-muted mb-0">
			                    <strong>※ 양식을 다운로드 후 양식에 맞춰 업로드해주세요</strong>
			                </p>
			                <button class="btn btn-success" id="btn_excel_template">
			                    <i class="fas fa-download"></i> 양식 다운로드
			                </button>
			            </div>
			            <div class="input-group mb-3">
			                <input type="file" class="form-control" id="excelFile">
			                <div class="input-group-append">
			                    <button class="btn btn-primary" id="btn_excel_upload">불러오기</button>
			                    <button class="btn btn-primary" id="btn_db_update">업로드</button>
			                    <button class="btn btn-danger" id="btn_ㄷxcel_reset">초기화</button>
			                </div>
			            </div>
			        </div>
			    </div>
			</div>
			<!-- /.모달창 바디 -->
			<!-- 모달창 푸터-->
			<div>
				<div class="modal-footer justify-content-between">
					<button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
				</div>
			</div>
			<!-- /.모달창 푸터-->
		</div>
	</div>
</div>
<!-- /.모달창 -->

<script th:fragment="excelModal" th:inline="javascript">
	
	/* 
	====================코드중복체크 모달 사용법 ===========================
	모달 show이전에 아래의 값들을 할당해야함.
	workcenter.html 참고.
	=================================================================
	button.addEventListener('click', function() {
		const row = props.rowKey;
		const column = props.columnInfo.name;
		const value = processGrid.getValue(row, column);  // 사용할 그리드 - 변경필요.
		
		$("#inputCodeText").val(value);  // 그리드에 출력되어있는 기존의 값
		$("#gridCheckedRow").val(row);  // 선택한 행
		$("#gridCheckedColumn").val(column);  // 선택한 열
		
		tableName = "PROCESS";  // DB테이블명 - 변경필요.
		tableCodeId = "PROCESS_ID";  // 중복체크할 컬럼 ID - 변경필요.
		copyGrid = processGrid;  // 선택한값 집어넣을 그리드 객체 - 변경필요.
		
		// 위에서 변경필요한 값들 수정한 다음 모달 띄움.
		$('#mesCodeValidate').modal();
	}
	*/
	
	let tableName = "";
	let tableCodeId = "";
	let copyGrid = null;
	
	// 전역 객체에서 모든 그리드 인스턴스를 순회하며 보이는 그리드를 찾음
	// 현재 화면에 보이는 그리드 중 가장 먼저 찾은 그리드를 반환
	function findGrid() { 
	    let activeGrid = null;
		
	    for (let key in window.gridInstances) {
	        if (window.gridInstances.hasOwnProperty(key)) {
	            let gridInfo = window.gridInstances[key];
	            if ($(gridInfo.element).is(":visible")) {
	                activeGrid = gridInfo.instance;
	                break;
	            }
	        }
	    }
		
	    return activeGrid;
	}
	
	// 특정 key 값에 해당하는 Grid 찾기
	/*
	function findGridByKey(gridKey) {
	    for (let key in window.gridInstances) {
	        if (window.gridInstances.hasOwnProperty(key)) {
	            let gridInfo = window.gridInstances[key];
	            if (gridInfo.element.id === gridKey) { // gridKey에 해당하는 ID 찾기
	                return gridInfo.instance;
	            }
	        }
	    }
		
	    return null;
	}
	*/
	
	// 엑셀 데이터를 Grid의 name과 자동 매핑
	function autoMapExcelData(excelData, gridInstance) {
	    if (excelData.length === 0) 
			return [];
	
	    // Toast UI Grid 컬럼 정보 가져오기 - [{name, header}, ...]
	    const gridColumns = gridInstance.getColumns();
	
	    // 첫 번째 행 (엑셀 header) 추출
	    const excelHeaders = Object.keys(excelData[0]);
	
	    // 엑셀 header와 Grid의 name을 자동 매핑
	    const headerMap = {};
	    gridColumns.forEach(column => {
	        let matchedHeader = excelHeaders.find(header => header === column.header); // header 값이 일치하는지 확인
	        if (matchedHeader) {
	            headerMap[matchedHeader] = column.name; // 'header' → 'name'
	        }
	    });
	
	    console.log("자동 매핑 결과 : ", headerMap);
	
	    // 엑셀 데이터를 Grid의 name 기준으로 변환
	    return excelData.map(row => {
	        let newRow = {};
	        Object.keys(row).forEach(header => {
	            if (headerMap[header]) {
	                newRow[headerMap[header]] = row[header]; // 매칭된 키로 변경
	            }
	        });
	        return newRow;
	    });
	}

	// 엑셀 업로드 버튼 클릭 이벤트
	$('#btn_excel_upload').on('click', function () {
		
	    let fileInput = document.getElementById('excelFile');
	    let file = fileInput.files[0];

	    if (!file) {
	        alert("파일을 선택하세요.");
	        return;
	    }
	    
	    let formData = new FormData();
	    formData.append("file", file);
	    
		$.ajax({
			url: "/ajax/uploadExcel", // 서버 업로드 URL
			type: "POST",
			data: formData,
			processData: false,
			contentType: false,
			success: function (res) {
				console.log("엑셀 데이터 : ", res);
				
	            // 전역 객체에서 모든 그리드 인스턴스를 순회하며 보이는 그리드를 찾음
	            let activeGrid = findGrid();

	            if (activeGrid) {
	                // 엑셀 데이터를 Grid의 name에 맞게 자동 변환
	                let transformedData = autoMapExcelData(res, activeGrid);
	                console.log("엑셀 데이터 (매핑 전) :", res);
	                console.log("엑셀 데이터 (매핑 후) :", transformedData);

	                alert("엑셀 불러오기 성공!");
	                activeGrid.resetData(transformedData); // 변환된 데이터 적용
	            } else {
	                alert("보이는 그리드를 찾을 수 없습니다.");
	                alert("엑셀 불러오기 실패!");
	            }
			},
			error: function (err) {
				console.error("업로드 실패 : ", err);
				alert("엑셀 업로드 중 오류가 발생했습니다.");
			}
		});
	});
	
	// 엑셀 업로드시 수정된 행(row)만 db에 업데이트 이벤트 (수정 중)
	// 250209 TODO : 수정 구현, 수정할 때 엑셀 header에서 
	// 괄호 안 내용만을 인식하고 그걸 가지고 수정 필요
	$('#btn_db_update').on('click', function () {
		
		// 엑셀 파일 업로드시 수정된 행(row)만 db에 업데이트
		let fileInput = document.getElementById('excelFile');
		let file = fileInput.files[0];
	
		if (!file) {
			alert("파일을 선택하세요.");
			return;
		}
	
		let formData = new FormData();
		formData.append("file", file);
		formData.append("tableName", tableName);  // 적용할 테이블명
		formData.append("tableCodeId", tableCodeId);  // 기본 키 컬럼명 (ex: "ID")
	
		$.ajax({
			url: "/ajax/updateExcelData",
			type: "POST",
			data: formData,
			processData: false,
			contentType: false,
			success: function (res) {
				
				// 전역 객체에서 모든 그리드 인스턴스를 순회하며 보이는 그리드를 찾음
				/*
				let activeGrid = findGrid();
				
				if (activeGrid) {
					alert(res.message);
					grid.reloadData();  // 업로드 후 그리드 새로고침
				} else {
				    alert("보이는 그리드를 찾을 수 없습니다.");
				    alert("엑셀 불러오기 실패!");
				}
				*/
				
				alert(res.message);
				grid.reloadData();  // 업로드 후 그리드 새로고침
			},
			error: function (xhr, status, err) {
				console.error("DB 업데이트 실패 : ", err);
				alert("엑셀 DB 업데이트 중 오류가 발생했습니다.");
			}
		});
	});
	
	// 엑셀 양식 다운로드 버튼 클릭 이벤트
	$('#btn_excel_template').on('click', function () {
		// Grid에서 헤더 정보 가져오기
		const grid = findGrid(); // 현재 화면에 보이는 Grid 가져오기
		
		if (!grid) {
		    alert("현재 화면에 표시된 그리드가 없습니다.");
		    return;
		}
		
		const headers = grid.getColumns().map(col => `${col.header}[${col.name}]`);
		
		$.ajax({
			url: "/ajax/downloadTemplate",
			method: "POST",
			contentType: "application/json",
			data: JSON.stringify({
			    tableName: tableName,
			    headers: headers
			}),
			xhrFields: {
				responseType: "blob"  // 바이너리 데이터로 응답 받기
			},
			success: function (data) {
				// 바이너리 데이터를 URL 객체로 변환 및 새로운 <a> (링크) 요소 생성
				const url = window.URL.createObjectURL(data);
				const a = document.createElement("a");
	
				// 다운로드 속성 설정
				a.href = url;
				a.download = tableName + "_template.xlsx";
	
				// 링크를 클릭하여 다운로드 시작
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
	
				// URL 해제
				window.URL.revokeObjectURL(url);
			},
			error: function (xhr, status, error) {
				console.error("다운로드 실패 : ", error);
			}
		});
	});

</script>
