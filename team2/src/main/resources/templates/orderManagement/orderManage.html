<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<title>AdminLTE 3 | DataTables</title>

<!-- Google Font: Source Sans Pro -->
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<!-- Font Awesome -->
<link rel="stylesheet"
	href="../../plugins/fontawesome-free/css/all.min.css">
<!-- Theme style -->
<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
<!-- custom style -->
<link rel="stylesheet" href="../../dist/css/custom.css">

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
	crossorigin="anonymous">

<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />

<link rel="stylesheet"
	href="https://uicdn.toast.com/select-box/latest/toastui-select-box.css" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.1/dist/css/bootstrap-select.min.css"
	rel="stylesheet">

</head>
<body class="hold-transition sidebar-mini">
	<div class="wrapper">

		<!-- 상단 메뉴 -->
		<nav th:replace="~{includes/navbar :: navbar}"></nav>
		<!-- /.상단 메뉴 -->

		<!-- 좌측 메뉴 -->
		<aside th:replace="~{includes/sidebar :: sidebar}"></aside>
		<!-- /.좌측 메뉴 -->

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- 콘텐츠 헤더 (Page header) -->
			<nav th:replace="~{includes/pageHeader :: pageHeader}"></nav>

			<nav th:replace="~{includes/modals/orderDetail :: orderDetail}"></nav>

			<!-- 메인 콘텐츠 -->
			<section class="content contentOrder">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card mx-3">
								<div class="d-flex justify-content-between px-3 py-3">
									<div class="d-flex">
										<div class="d-flex">
											<div class="custom-label">수주기간 :</div>
											<div
												class="tui-datepicker-input tui-datetime-input tui-has-focus">
												<input id="startpicker-input" type="text" aria-label="Date">
												<span class="tui-ico-date"></span>
												<div id="startpicker-container" style="margin-left: -1px;"></div>
											</div>
											<span class="mx-2">~</span>
											<div
												class="tui-datepicker-input tui-datetime-input tui-has-focus">
												<input id="endpicker-input" type="text" aria-label="Date">
												<span class="tui-ico-date"></span>
												<div id="endpicker-container" style="margin-left: -1px;"></div>
											</div>
										</div>
										<div class="d-flex ml-4">
											<div class="custom-label">거래처 :</div>
											<select id="cusInput" class="selectpicker"
												data-live-search="true"></select>
										</div>
										<div class="d-flex ml-4">
											<div class="custom-label">품목 :</div>
											<select id="itemInput" class="selectpicker"
												data-live-search="true"></select>
										</div>
										<div class="d-flex ml-4">
											<div class="custom-label">수주번호 :</div>
											<input type="text" class="form-control" id="idInput">
										</div>
										<div class="d-flex align-items-center ml-4">
											<div class="custom-label">진행상태 :</div>
											<div class="form-check form-switch">
												<input class="form-check-input" type="checkbox"
													role="switch" id="statusInput">
											</div>
										</div>
									</div>
									<div class="card-tools">
										<!-- <input type="button" id="btn_add_row" class="btn btn-primary" value="행추가"> -->
										<input type="button" id="btn_search"
											class="btn btn-primary btn-sm" value="조회"> <input
											type="button" id="btn_insert" class="btn btn-primary btn-sm"
											value="등록"> <input type="button" id="btn_update"
											class="btn btn-primary btn-sm" value="수정"> <input
											type="button" id="btn_delete" class="btn btn-primary btn-sm"
											value="삭제">
									</div>
								</div>

							</div>
							<div class="card-body" id="ord_grid">
								<!-- Toast Grid Ajax -->
							</div>
							<!-- /.card-body -->
						</div>
						<!-- /.card -->
					</div>
					<!-- /.col -->
				</div>
				<!-- /.row -->
		</div>
		<!-- /.container-fluid -->
		</section>
		<!-- /.content -->
	</div>
	<!-- /.content-wrapper -->
	<!-- 좌측 메뉴 -->
	<footer th:replace="~{includes/footer :: footer}"></footer>
	<!-- /.좌측 메뉴 -->
	<!-- Control Sidebar -->
	<aside class="control-sidebar control-sidebar-dark">
		<!-- Control sidebar content goes here -->
	</aside>
	<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->

	<!-- jQuery -->
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../../dist/js/adminlte.min.js"></script>

	<script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>
	<script
		src="https://uicdn.toast.com/select-box/latest/toastui-select-box.js"></script>
	<script
		src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
	<script
		src="https://uicdn.toast.com/autocomplete/latest/toastui-autocomplete.min.js"></script>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.1/dist/js/bootstrap-select.min.js"></script>


	<!-- Page specific script -->
	<script th:inline="javascript">
    
    var grid;
    
    const url = '/ajax/order';  // API URL
    
    // 페이지 로딩 후 데이터 로드
    document.addEventListener("DOMContentLoaded", function () {
        loadGridData();
        loadClientList();    
        loadItemList();
    });

    function loadGridData() {
        fetch(url) 
            .then(response => response.json()) 
            .then(data => {
                console.log("수주 데이터 로드 성공", data);

                // 그리드 설정
                grid = new tui.Grid({
                    el: document.getElementById('ord_grid'),
                    data: data.orders, 
                    scrollX: true,
                    scrollY: true,
                    rowHeaders: ['checkbox'],
                    columnOptions: {
                        resizable: true,
                    },
                    columns: [
                        { header: '수주일자', name: 'ORDER_DATE', align: 'center', width: 110 },
                        { header: '수주번호', name: 'ORDER_ID', align: 'center', formatter: function(value) { 
                            return `<a href="#" id="${value.value}" class="edit-link"> ${value.value}</a>`; 
                        }},
                        { header: '진행상태', name: 'ORDER_STATUS', align: 'center', width: 80, 
                          renderer: {
                              styles: {
                                  fontWeight: 'bold',
                                  color: (props) => props.value == '미결' ? '#ff6464' : '#999'
                              }
                          }
                        },
                        { header: '거래처', name: 'CUSTOMER_ID', align: 'left' },
                        { header: '담당자', name: 'SALES_REP_ID', align: 'center', width: 100 },
                        { header: '품목명', name: 'ITEM_ID', align: 'left' },
                        { header: '납품예정일', name: 'DELIVERY_DATE', align: 'center', width: 95 }, 
                        { header: '수주수량', name: 'ORDER_QTY', align: 'right', width: 80, 
                          formatter: function(value) { return Number(value.value).toLocaleString(); }
                        },
                        { header: '출하수량', name: 'SHIPPED_QTY', align: 'right', width: 80, 
                          formatter: function(value) { return Number(value.value).toLocaleString(); }
                        },
                        { header: '수주잔량', name: 'BACKLOG', align: 'right', width: 80, 
                          formatter: function(value) { return Number(value.value).toLocaleString(); }
                        },
                        { header: '등록자', name: 'REGIST_BY', align: 'center', width: 100 },
                        { header: '수정일자', name: 'UPDATE_DATE', align: 'center', width: 110 },
                        { header: '비고', name: 'REMARKS', align: 'left' }
                    ],
                });

                // 오류 응답 처리
                grid.on('failResponse', function (ev) {
                    alert(JSON.parse(ev.xhr.responseText).message);
                });
            })
            .catch(error => {
                console.error("데이터 로딩 실패", error);
            });
    }

    // 수주번호 클릭 시 모달로 상세 내용 로드
    document.getElementById('ord_grid').addEventListener('click', function(event) {
        if (event.target && event.target.matches('a.edit-link')) {
            event.preventDefault();
            var id = event.target.id;
            console.log("클릭된 수주번호", id);
            loadModalContent(id);
        }
    });

    // 수주 상세 정보 로드
    function loadModalContent(id) {
        fetch(`${url}?orderId=${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('수주 상세 정보를 불러오는 데 실패했습니다.');
                }
                return response.json();
            })
            .then(data => {
                console.log("data :" + data.orders[0]);
                
                const order = data.orders[0];
                
                if (data) {
                    console.log("수주 상세 정보:", data);
                    document.getElementById('orderDate').innerText = order.ORDER_DATE;
                    document.getElementById('orderId').innerText = order.ORDER_ID;
                    document.getElementById('registBy').innerText = order.REGIST_BY;
                    document.getElementById('customerId').innerText = order.CUSTOMER_ID;
                    document.getElementById('salesRepId').innerText = order.SALES_REP_ID;
                    document.getElementById('deliveryDate').innerText = order.DELIVERY_DATE;
                    document.getElementById('itemId').innerText = order.ITEM_ID;
                    document.getElementById('unit').innerText = order.UNIT;
                    document.getElementById('itemPrice').innerText = order.ITEM_PR.toLocaleString() + ' 원';;
                    document.getElementById('orderPrice').innerText = order.ORDER_PR.toLocaleString() + ' 원';;
                    document.getElementById('tax').innerText = order.TAX.toLocaleString() + ' 원';;
                    document.getElementById('orderSum').innerText = order.ORDER_SUM.toLocaleString() + ' 원';;
                    document.getElementById('remarks').innerText = order.REMARKS ? order.REMARKS : ' ';

                    $('#modal-lg').modal('show');
                } else {
                    alert('수주 상세 정보를 불러오는 데 실패했습니다.');
                }
            })
            .catch(error => {
                alert(error.message);
            });
    }

    
 	// 거래처 Select Box
    function loadClientList() {
        fetch('/purchase/purchaseClt') 
            .then(response => response.json()) 
            .then(data => {
                console.log("거래처 리스트 데이터:", data);
                updateSelectBox(data.data.contents, 'cusInput');  // 'cusInput' SelectBox 업데이트
            })
            .catch(error => {
                console.error("거래처 리스트를 불러오는 데 실패했습니다.", error);
            });
    }

    // 품목 Select Box
    function loadItemList() {
        fetch('/getMaterialList') 
            .then(response => response.json()) 
            .then(data => {
                console.log("품목 리스트 데이터:", data);
                updateSelectBox(data, 'itemInput');  // 'itemInput' SelectBox 업데이트
            })
            .catch(error => {
                console.error("품목 리스트를 불러오는 데 실패했습니다.", error);
            });
    }

    // selectBox의 옵션을 업데이트하는 함수
    function updateSelectBox(data, elementId) {
        const selectElement = document.getElementById(elementId);  // SelectBox를 삽입할 HTML 요소

        // 옵션 생성
        const options = [
            `<option value="all">전체</option>`,  // "전체" 옵션 추가
            ...data.map(item => {
                return `<option value="${item.CLIENT_ID || item.MATERIAL_ID}">${item.CLIENT_NAME || item.MATERIAL_NAME}</option>`;
            })
        ].join("");

        selectElement.innerHTML = options;  // 옵션을 SelectBox에 삽입

        $(selectElement).selectpicker('refresh');  // selectpicker 새로고침
    }
    
    //dateRange
 	const today = new Date();
    const startOfYear = new Date(today.getFullYear(), 0, 1);
    const DatePicker = tui.DatePicker;

    // startpicker와 endpicker의 초기 상태에서 캘린더를 숨김
    const rangePicker = DatePicker.createRangePicker({
        startpicker: {
            date: startOfYear,
            input: '#startpicker-input',
            container: '#startpicker-container',
            // 클릭하기 전에는 캘린더를 숨기도록 설정
            isVisible: false
        },
        endpicker: {
            date: today,
            input: '#endpicker-input',
            container: '#endpicker-container',
            // 클릭하기 전에는 캘린더를 숨기도록 설정
            isVisible: false
        },
        selectableRanges: [
            [startOfYear, today]
        ],
        type: 'date',
        format: 'YYYY-MM-dd'
    });

    // startpicker 클릭 시 캘린더를 열기
    document.getElementById('startpicker-input').addEventListener('click', function () {
        rangePicker.open('start');  // startpicker가 클릭되면 시작 날짜 캘린더 열기
    });

    // endpicker 클릭 시 캘린더를 열기
    document.getElementById('endpicker-input').addEventListener('click', function () {
        rangePicker.open('end');  // endpicker가 클릭되면 끝 날짜 캘린더 열기
    });
    
 	// delete btn
	document.getElementById('btn_delete').addEventListener('click', () => {
	    const selectedRowKeys = grid.getCheckedRowKeys();
	
	    if (selectedRowKeys.length === 0) {
	        alert('삭제할 행을 선택해주세요.');
	        return;
	    }
	
	    // 선택된 행의 orderId 값 가져오기
	    const orderIds = selectedRowKeys.map(rowKey => {
	        const rowData = grid.getRow(rowKey);
	        return rowData.ORDER_ID;  // 실제 필드명에 맞게 수정
	    });
	
	    // 서버로 삭제 요청 보내기
	    fetch(`${url}/delete`, {
	        method: 'DELETE',  // DELETE 메서드 사용
	        headers: {
	            'Content-Type': 'application/json',
	        },
	        body: JSON.stringify(orderIds),  // JSON 배열로 보내기
	    })
	    .then(response => response.json())  // 응답을 JSON으로 파싱
	    .then(data => {
	        if (data.success) {
	            // 삭제 성공 시 그리드에서 행 제거
	            grid.removeRows(selectedRowKeys);
	            alert('선택한 주문이 삭제되었습니다.');
	        } else {
	            alert(data.message);  // 오류 메시지 출력
	        }
	    })
	    .catch(error => {
	        console.error('Error:', error);
	        alert('서버와의 통신에 실패했습니다.');
	    });
	});


    
</script>

</body>
</html>