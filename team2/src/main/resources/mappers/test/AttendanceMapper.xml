<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 오라클 MyBatis 사용시 문장 끝에 세미콜론 있으면 오류남! -->

<mapper namespace="com.itwillbs.repository.AttendanceMapper">
    <select id="getMyCommuteHistory" resultType="map">
    <!-- getMyCommuteHistory 출퇴근기록 조회 -->
        SELECT 
		      TO_CHAR(CHECK_IN_TIME, 'YYYY-MM-DD')				AS commute_check_in_date
		    , TO_CHAR(CHECK_IN_TIME, 'HH24:MI:SS')				AS commute_check_in_time
		    , NVL(TO_CHAR(CHECK_OUT_TIME, 'HH24:MI:SS'), '-')	AS commute_check_out_time
		  FROM
		      COMMUTE
		 WHERE
		 	  1 = 1
		   AND
			  member_id = #{id}
			  <if test='startDate != null and startDate != ""
	   			 		and endDate != null and endDate != ""'>
				  AND 
					  TO_CHAR(CHECK_IN_TIME, 'YYYY-MM-DD') BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
													   		   AND TO_DATE(#{endDate}, 'YYYY-MM-DD') 
			  </if>
		 ORDER BY
		 	  CHECK_IN_TIME DESC
    </select>
    
    <select id="getMyCommuteHistoryMinMaxDate" resultType="map">
    <!-- getMyCommuteHistoryMinMaxDate 출퇴근기록에서 최대최소일 조회 -->
        SELECT 
		      MAX(TO_CHAR(CHECK_IN_TIME, 'YYYY-MM-DD'))	AS commute_max_date
		    , MIN(TO_CHAR(CHECK_IN_TIME, 'YYYY-MM-DD')) AS commute_min_date
		  FROM
		      COMMUTE
	     WHERE
			  1 = 1
		   AND
			  member_id = #{id}
    </select>
    
    
    <select id="getMyAttendanceHistory" resultType="map">
    <!-- getMyAttendanceHistory 지각/조퇴/결근 기록 조회 -->
	SELECT 
		  ID
		, MEMBER_ID
		, CHECK_IN_TIME
		, CHECK_OUT_TIME
		, ATTENDANCE_TEXT
		, TO_CHAR(TO_DATE(CT_CHECK_IN_TIME, 'HH24:MI:SS'), 'HH24:MI:SS')										AS CT_CHECK_IN_TIME
		, TO_CHAR(TO_DATE(CT_CHECK_OUT_TIME, 'HH24:MI:SS'), 'HH24:MI:SS')										AS CT_CHECK_OUT_TIME
		, TO_CHAR(CREATE_DATE, 'YYYY-MM-DD')																	AS CREATE_DATE
	  FROM (
		  SELECT 
				ID
			  , MEMBER_ID
			  , CHECK_IN_TIME
			  , CHECK_OUT_TIME
			  , ATTENDANCE_TEXT
			  , CREATE_DATE
			  , CT_CHECK_IN_TIME
		  	  , CT_CHECK_OUT_TIME
			  , ROW_NUMBER() OVER(PARTITION BY ID ORDER BY CT_STARTING_DATE DESC)								AS ROW_NUM
		   FROM (
			   SELECT
			         c.id																						AS ID
			       , c.MEMBER_ID 																				AS MEMBER_ID
			       , TO_CHAR(c.CHECK_IN_TIME, 'HH24:MI:SS')														AS CHECK_IN_TIME 	
			       , TO_CHAR(c.CHECK_OUT_TIME, 'HH24:MI:SS')													AS CHECK_OUT_TIME
				   , CASE 
				  	     WHEN TO_CHAR(c.CHECK_IN_TIME, 'HH24:MI:SS') > ct.CHECK_IN_TIME THEN '지각' 
				         WHEN TO_CHAR(c.CHECK_OUT_TIME, 'HH24:MI:SS')<![CDATA[<]]>ct.CHECK_OUT_TIME THEN '조퇴' 
				         ELSE '정상출근'
				     END																						AS ATTENDANCE_TEXT
			       , c.CREATE_DATE 																				AS CREATE_DATE
			       , ct.STARTING_DATE 																			AS CT_STARTING_DATE
			       , ct.CHECK_IN_TIME 																			AS CT_CHECK_IN_TIME
				   , ct.CHECK_OUT_TIME 																			AS CT_CHECK_OUT_TIME
			     FROM
			         COMMUTE																					   c
			         INNER JOIN COMMUTE_TIME 																	   ct 
			      		     ON TO_CHAR(c.CREATE_DATE , 'YYYY-MM-DD') >= ct.STARTING_DATE
			    WHERE
			         1 = 1
			      AND
			         c.member_id = #{id}
			    ORDER BY 
			         c.check_in_time DESC
		)
		ORDER BY
		 	 CREATE_DATE DESC
	)
	 WHERE
	 	  1 = 1
	   AND
	 	  ROW_NUM = 1
 	  <if test='startDate != null and startDate != ""
		 		and endDate != null and endDate != ""'>
		  AND 
			  TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
											   		 AND TO_DATE(#{endDate}, 'YYYY-MM-DD') 
	  </if>
    </select>
    
    <select id="getMyCommuteTimeMinMaxDate" resultType="map">
    <!-- getMyCommuteHistoryMinMaxDate 출퇴근기록에서 최대최소일 조회 -->
		SELECT 
		     MAX(STARTING_DATE)		AS MAX_STARTING_DATE
		   , MIN(STARTING_DATE) 	AS MIN_STARTING_DATE
		 FROM
		     COMMUTE_TIME
		WHERE
		  	 1 = 1
		  AND
		  	 member_id = #{id}
    </select>
    
    <select id="getMyCommuteTime" resultType="map">
    <!-- getMyCommuteTime 내 출퇴근 기준 시간 조회 -->
		SELECT
		  	  CHECK_IN_TIME 	AS CHECK_IN_TIME
			, CHECK_OUT_TIME 	AS CHECK_OUT_TIME
			, STARTING_DATE 	AS STARTING_DATE
	  	  FROM 
		 	  COMMUTE_TIME
		 WHERE
		  	  1 = 1
		   AND
		  	  member_id = #{id}
	  	  <if test='startDate != null and startDate != ""
   			 		and endDate != null and endDate != ""'>
			  AND 
				  STARTING_DATE BETWEEN #{startDate} 
									AND #{endDate} 
		  </if>
  	     ORDER BY
 	  		  STARTING_DATE DESC
    </select>

</mapper>