<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 오라클 MyBatis 사용시 문장 끝에 세미콜론 있으면 오류남! -->

<mapper namespace="com.itwillbs.repository.MenuMapper">
    <select id="selectMenu" resultType="map">
        SELECT *
          FROM MENU
         WHERE ROLE LIKE CONCAT(CONCAT('%', #{auth}), '%')
         ORDER BY DEPTH, SORT_ORDER ASC 
    </select>
    
    <select id="getMenuList" resultType="map">
	    SELECT
			   MENU_ID 
			 , PARENT_ID
			 , NAME 
			 , URL 
			 , ROLE 
			 , SORT_ORDER
			 , DEPTH
			 , USE_YN 
			 , CASE 
			 		WHEN URL IS NULL THEN '폴더'
			 		ELSE '페이지'
			 	END	AS TYPE
		  FROM MENU
		 WHERE 
		 	   1 = 1
		   <if test="depth != null and depth != ''">
		   	   AND DEPTH = #{depth}
		   </if>
		   <if test="parent_id != null and parent_id != ''">
		   	   AND PARENT_ID = #{parent_id}
		   </if>
		   <if test="menu_id != null and menu_id != ''">
		   	   AND MENU_ID = #{menu_id}
		   </if>
		 ORDER BY SORT_ORDER ASC
    </select>
    
    <insert id="insertMenu">
    	INSERT INTO MENU (
			  MENU_ID
			, NAME
			, PARENT_ID
			, URL
			, ROLE
			, SORT_ORDER
			, DEPTH
			, USE_YN
		) VALUES (
			  (SELECT 'ME' || LPAD(NVL(MAX(TO_NUMBER(SUBSTR(MENU_ID, 3))), 0) + 1, 10, '0') FROM MENU)
			, #{NAME}
			, #{PARENT_ID}
			, #{URL}
			, #{ROLE}
			, #{SORT_ORDER}
			, #{DEPTH}
			, #{USE_YN}
		)
    </insert>
    
    <select id="isDuplicateMenuSortOrder" resultType="Integer">
    	SELECT COUNT(*) AS COUNT
		  FROM MENU
		 WHERE 1 = 1
		   <choose>
		   	   <when test="PARENT_ID != null and PARENT_ID != ''">
		   	   		AND PARENT_ID = #{PARENT_ID}
		   	   </when>
		   	   <otherwise>
		   	   		 AND PARENT_ID IS NULL
		   	   </otherwise>
		   </choose>
		   <if test="MENU_ID != null and MENU_ID != ''">
		   		AND MENU_ID != #{MENU_ID}
		   </if>
		   AND SORT_ORDER = #{SORT_ORDER}
    </select>
    
    <select id="isDuplicateMenuURL" resultType="Integer">
    	SELECT COUNT(*) AS COUNT
		  FROM MENU
		 WHERE 1 = 1
		   AND URL IS NOT NULL
		   AND URL = #{URL}
   		   <if test="MENU_ID != null and MENU_ID != ''">
		   		AND MENU_ID != #{MENU_ID}
		   </if>
    </select>
    
    <select id="isExistChildMenu" resultType="Integer">
	    SELECT COUNT(*) AS COUNT
		  FROM MENU
		 WHERE 1 = 1
		   AND PARENT_ID = #{MENU_ID}
    </select>
    
    <update id="updateMenu">
    	UPDATE MENU
		   SET 
			     NAME = #{NAME}
			   , URL = #{URL, jdbcType=VARCHAR}
			   , SORT_ORDER = #{SORT_ORDER}
			   , ROLE = #{ROLE}
			   , USE_YN = #{USE_YN}
		 WHERE MENU_ID = #{MENU_ID}
    </update>
</mapper>