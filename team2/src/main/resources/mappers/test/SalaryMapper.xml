<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 오라클 MyBatis 사용시 문장 끝에 세미콜론 있으면 오류남! -->

<mapper namespace="com.itwillbs.repository.SalaryMapper">

    <select id="selectSalaryList" resultType="map">
    <!-- selectSalaryList - 급여기록 조회 -->
    <!-- getSalaryListMinMaxDate에서 조회된 최대최소일 범위의 급여기록 조회 -->
        SELECT
            S.PAYDAY,
            M.MEMBER_ID,
            M.NAME,
            S.GRADE_ID,
            M.DEPT_ID,
            M.SALARY,
            S.POSITION_BONUS,
            S.HOLIDAY_BONUS,
            S.NIGHT_BONUS,
            S.YEAREND_BONUS,
            S.FULLSERVICE_BONUS,
            S.PERFORMANCE_BONUS,
            (M.SALARY + S.POSITION_BONUS + S.HOLIDAY_BONUS + S.NIGHT_BONUS + 
             S.YEAREND_BONUS + S.FULLSERVICE_BONUS + S.PERFORMANCE_BONUS) AS TOTAL
        FROM MEMBER M
        LEFT JOIN SALARY S
          ON M.MEMBER_ID = S.MEMBER_ID
		WHERE
			1 = 1
			<if test='id != "admin"'>
			   AND
				  S.MEMBER_ID = #{id}
		  	</if>
			<if test='startDate != null and startDate != "" 
						and endDate != null and endDate != ""'>
				AND 
					PAYDAY BETWEEN #{startDate} 
					AND #{endDate} 
			</if>
		ORDER BY
			PAYDAY DESC
    </select>
    
    <select id="getSalaryListMinMaxDate" resultType="map">
     <!-- getSalaryInputMinMaxDate - 급여조회에서 최대최소일 조회 -->
        SELECT 
		      MAX(PAYDAY)	AS SALARY_MAX_DATE
    		, MIN(PAYDAY) 	AS SALARY_MIN_DATE
		FROM
		      SALARY
	    WHERE
			  1 = 1
		  <if test='id != "admin"'>
			  AND
				 member_id = #{id}
		  </if>
    </select>
    
    <select id="selectSalaryListById" resultType="map">
    <!-- 사원ID에 해당하는 급여정보를 조회 -->
		 SELECT
            S.PAYDAY,
            M.MEMBER_ID,
            M.NAME,
            S.GRADE_ID,
            M.DEPT_ID,
            M.SALARY,
            S.POSITION_BONUS,
            S.HOLIDAY_BONUS,
            S.NIGHT_BONUS,
            S.YEAREND_BONUS, 
            S.FULLSERVICE_BONUS,
            S.PERFORMANCE_BONUS,
            (M.SALARY + S.POSITION_BONUS + S.HOLIDAY_BONUS + S.NIGHT_BONUS + 
             S.YEAREND_BONUS + S.FULLSERVICE_BONUS + S.PERFORMANCE_BONUS) AS TOTAL
		FROM 
			MEMBER M
		LEFT JOIN SALARY S
          ON M.MEMBER_ID = S.MEMBER_ID
		WHERE
			1 = 1
		AND
			M.MEMBER_ID = #{id}
		ORDER BY
			PAYDAY DESC
		
    </select>
    
    <!-- 사원별 급여 입력(관리자) -->
	<insert id="insertSalary" parameterType="map">
<!-- 	    INSERT ALL -->
<!-- 	        INTO SALARY ( -->
<!-- 	            <trim prefix="" suffix="" suffixOverrides=","> -->
<!-- 	                <if test="PAYDAY != null"> PAYDAY, </if> -->
<!-- 	                <if test="MEMBER_ID != null"> MEMBER_ID, </if> -->
<!-- 	                <if test="GRADE_ID != null"> GRADE_ID, </if> -->
<!-- 	                <if test="POSITION_BONUS != null"> POSITION_BONUS, </if> -->
<!-- 	                <if test="HOLIDAY_BONUS != null"> HOLIDAY_BONUS, </if> -->
<!-- 	                <if test="NIGHT_BONUS != null"> NIGHT_BONUS, </if> -->
<!-- 	                <if test="YEAREND_BONUS != null"> YEAREND_BONUS, </if> -->
<!-- 	                <if test="FULLSERVICE_BONUS != null"> FULLSERVICE_BONUS, </if> -->
<!-- 	                <if test="PERFORMANCE_BONUS != null"> PERFORMANCE_BONUS </if> -->
<!-- 	            </trim> -->
<!-- 	        ) -->
<!-- 	        VALUES ( -->
<!-- 	            <trim prefix="" suffix="" suffixOverrides=","> -->
<!-- 	                <if test="PAYDAY != null"> #{PAYDAY}, </if> -->
<!-- 	                <if test="MEMBER_ID != null"> #{MEMBER_ID}, </if> -->
<!-- 	                <if test="GRADE_ID != null"> #{GRADE_ID}, </if> -->
<!-- 	                <if test="POSITION_BONUS != null"> #{POSITION_BONUS}, </if> -->
<!-- 	                <if test="HOLIDAY_BONUS != null"> #{HOLIDAY_BONUS}, </if> -->
<!-- 	                <if test="NIGHT_BONUS != null"> #{NIGHT_BONUS}, </if> -->
<!-- 	                <if test="YEAREND_BONUS != null"> #{YEAREND_BONUS}, </if> -->
<!-- 	                <if test="FULLSERVICE_BONUS != null"> #{FULLSERVICE_BONUS}, </if> -->
<!-- 	                <if test="PERFORMANCE_BONUS != null"> #{PERFORMANCE_BONUS} </if> -->
<!-- 	            </trim> -->
<!-- 	        ) -->
<!-- 	        INTO MEMBER ( -->
<!-- 	            <trim prefix="" suffix="" suffixOverrides=","> -->
<!-- 	                <if test="NAME != null"> NAME, </if> -->
<!-- 	                <if test="DEPT_ID != null"> DEPT_ID, </if> -->
<!-- 	                <if test="SALARY != null"> SALARY </if> -->
<!-- 	            </trim> -->
<!-- 	        ) -->
<!-- 	        VALUES ( -->
<!-- 	            <trim prefix="" suffix="" suffixOverrides=","> -->
<!-- 	                <if test="NAME != null"> #{NAME}, </if> -->
<!-- 	                <if test="DEPT_ID != null"> #{DEPT_ID}, </if> -->
<!-- 	                <if test="SALARY != null"> #{SALARY} </if> -->
<!-- 	            </trim> -->
<!-- 	        ) -->
<!-- 	    SELECT * FROM dual -->

		INSERT INTO salary (
		        PAYDAY,
		        MEMBER_ID,
		        GRADE_ID,
		        POSITION_BONUS,
		        HOLIDAY_BONUS,
		        NIGHT_BONUS,
		        YEAREND_BONUS,
		        FULLSERVICE_BONUS,
		        PERFORMANCE_BONUS
		    )
		    SELECT 
		        #{PAYDAY}
		        m.member_id,
		        m.grade_id,
		        #{POSITION_BONUS}
		        #{HOLIDAY_BONUS}
		        #{NIGHT_BONUS}
		        #{YEAREND_BONUS}
		        #{FULLSERVICE_BONUS}
		        #{PERFORMANCE_BONUS}
		    FROM member m
		    WHERE NOT EXISTS (
		        SELECT 1
		        FROM salary s
		        WHERE s.member_id = m.member_id
		    )		
	</insert>
 	
 	<!-- 급여 수정 - 사원의 기본금 수정 -->
	<update id="updateMemberSalary" parameterType="map">
		UPDATE MEMBER 
	   	   SET 
	   	   	   SALARY = #{salary}
		WHERE 
			 MEMBER_ID = #{memberId}
	</update>
	
	<!-- 급여 수정 - 사원의 상여금(보너스) 수정 -->
	<update id="updateSalaryBonus" parameterType="map">
		UPDATE SALARY 
	   	   SET 
	   	   	   PAYDAY = #{payday}
	   	   	 , POSITION_BONUS = #{positionBonus}
	       	 , HOLIDAY_BONUS = #{holidayBonus}
	       	 , NIGHT_BONUS = #{nightBonus}
	       	 , YEAREND_BONUS = #{yearendBonus}
	       	 , FULLSERVICE_BONUS = #{fullserviceBonus}
	       	 , PERFORMANCE_BONUS = #{performanceBonus}
	       	 , UPDATE_DATE = SYSDATE
		WHERE 
			 MEMBER_ID = #{memberId}
	</update>

</mapper>