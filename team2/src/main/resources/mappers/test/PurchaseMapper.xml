<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 오라클 MyBatis 사용시 문장 끝에 세미콜론 있으면 오류남! -->

<mapper namespace="com.itwillbs.repository.PurchaseMapper">
	
<!--	발주 리스트-->
	<select id="getPurchaseList" resultType="map">	
	SELECT PO_ID,
		   PO_NUM,
		   PO_COUNT,
		   PO_PRICE,
		   TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') AS CREATE_DATE,
		   (SELECT NAME FROM MEMBER M1 WHERE M1.MEMBER_ID = PO.MEMBER_ID) AS MEMBER_NAME,
		   CUSTOMER_ID,
		   PO_STATUS,
		   TO_CHAR(UPDATE_DATE, 'YYYY-MM-DD') AS UPDATE_DATE,
		   (SELECT NAME FROM MEMBER M2 WHERE M2.MEMBER_ID = PO.UPDATE_MEMBER) AS UPDATE_MEMBER
	FROM 
		PURCHASE_ORDER PO
	</select>
	
<!--	발주 등록-->
	<insert id="insertPurchase">
	INSERT INTO PURCHASE_ORDER (
			PO_ID
		  , CREATE_DATE
		  , MEMBER_ID
		  , CUSTOMER_ID
		  , PO_STATUS
		  , PO_NUM		
		) VALUES (
        'PO-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || LPAD(PO_SEQ.NEXTVAL, 4, '0'), 
          CURRENT_DATE, 
        #{INSERT_MEM}, 
        #{CUSTOMER_ID, jdbcType=VARCHAR}, 
        #{PO_STATUS}, 
        'ORD-' || TO_CHAR(CURRENT_DATE, 'MMDD-HH24MISS')
    )
	</insert>
	
<!--	발주 수정-->
	<update id="updatePurchase">
    UPDATE PURCHASE_ORDER
    	SET 
       	 	CREATE_DATE = CURRENT_DATE,
       	 	CUSTOMER_ID = #{CUSTOMER_ID, jdbcType=VARCHAR},
       	 	UPDATE_DATE = CURRENT_DATE,
       	 	UPDATE_MEMBER = #{UPDATE_MEM},
       	 	PO_NUM = #{PO_NUM, jdbcType=VARCHAR}
    WHERE PO_ID = #{PO_ID, jdbcType=VARCHAR}  <!-- PO_ID를 기준으로 업데이트 -->
	</update>
	
	<!-- DELETE (데이터 삭제) -->
    <delete id="deletePurchase">
        DELETE FROM PURCHASE_ORDER 
        	WHERE PO_ID = #{PO_ID}
    </delete>
    
    <select id="getPurchaseDetail" resultType="map">
    SELECT
        p.MATERIAL_ID,
        m.MATERIAL_NAME,
        m.MATERIAL_PRICE
    FROM PURCHASE_ORDER p
    JOIN MATERIAL m
      ON p.MATERIAL_ID = m.MATERIAL_ID
    WHERE p.MATERIAL_ID = #{MATERIAL_ID, jdbcType=VARCHAR}   	
    </select>


    
    <insert id="insertDetail">
	INSERT INTO PURCHASE_ORDER (
		    MATERIAL_ID
		  , PO_COUNT
		  , PO_PRICE
		) VALUES (
        #{MATERIAL_ID}, 
        #{PO_COUNT}, 
        #{PO_PRICE} 
    )
	</insert>
    
    <!-- 모달창 재료 목록 -->
	<select id="getMaterialList" resultType="map">
    	SELECT MATERIAL_ID, MATERIAL_NAME, MATERIAL_PRICE
    	FROM MATERIAL
    </select>
</mapper>